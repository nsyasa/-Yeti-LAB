<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giri≈ü Yap - Yeti LAB</title>
    <meta name="description" content="Yeti LAB eƒüitim platformuna giri≈ü yapƒ±n. √ñƒürenci veya √∂ƒüretmen olarak ba≈ülayƒ±n.">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="img/favicon.svg">
    <link rel="apple-touch-icon" href="img/favicon.svg">

    <!-- Tailwind CSS - CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Main Styles (includes Nunito font) -->
    <link rel="stylesheet" href="styles/main.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="modules/toast.js"></script>

    <style>
        /* Auth page specific styles */
        .auth-bg {
            background: linear-gradient(135deg, #f0fdfa 0%, #ecfdf5 50%, #f0f9ff 100%);
            min-height: 100vh;
        }

        body.dark-mode .auth-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .auth-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .auth-card {
            background: rgba(30, 41, 59, 0.95);
        }

        /* Code input boxes */
        .code-box {
            width: 56px;
            height: 64px;
            font-size: 1.75rem;
            font-weight: 800;
            text-align: center;
            text-transform: uppercase;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .code-box:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 3px rgba(0, 151, 156, 0.2);
        }

        body.dark-mode .code-box {
            background: #1e293b;
            border-color: #475569;
            color: #fff;
        }

        /* OAuth buttons */
        .btn-oauth {
            transition: all 0.2s;
        }

        .btn-oauth:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Floating elements animation */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .floating-icon {
            animation: float 6s ease-in-out infinite;
        }

        .floating-icon:nth-child(2) {
            animation-delay: 1s;
        }

        .floating-icon:nth-child(3) {
            animation-delay: 2s;
        }

        /* Tab styles */
        .auth-tab {
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: var(--theme-color);
            color: white;
        }

        /* Classroom info animation */
        .classroom-found {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div class="auth-bg flex flex-col min-h-screen">
        <!-- Floating decorations -->
        <div class="fixed inset-0 pointer-events-none overflow-hidden">
            <div class="floating-icon absolute text-6xl opacity-20" style="top: 10%; left: 10%;">ü§ñ</div>
            <div class="floating-icon absolute text-6xl opacity-20" style="top: 20%; right: 15%;">üí°</div>
            <div class="floating-icon absolute text-6xl opacity-20" style="bottom: 20%; left: 20%;">‚ö°</div>
            <div class="floating-icon absolute text-6xl opacity-20" style="bottom: 30%; right: 10%;">üîß</div>
        </div>

        <!-- Main Content -->
        <div class="flex-grow flex items-center justify-center px-4 py-8 relative z-10">
            <div class="w-full max-w-md">
                <!-- Logo -->
                <div class="text-center mb-8">
                    <div class="flex items-center justify-center mb-4 cursor-pointer"
                        onclick="window.location.href='index.html'">
                        <img src="img/logo.svg" alt="Yeti LAB" class="w-16 h-16 mr-3">
                        <div class="brand-logo">
                            <h1 class="text-3xl text-gray-800 leading-tight flex items-baseline gap-1">
                                <span>Yeti</span><span class="brand-lab text-theme">LAB</span>
                            </h1>
                        </div>
                    </div>
                    <p class="text-gray-600 text-lg">Kodlama ve Robotik Eƒüitim Platformu</p>
                </div>

                <!-- Auth Card -->
                <div class="auth-card rounded-2xl p-8">
                    <!-- Decorative Background Element -->
                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-theme/5 rounded-full -mr-16 -mt-16 pointer-events-none">
                    </div>

                    <!-- Alert Box -->
                    <div id="alertBox" class="hidden mb-6 p-4 rounded-xl text-sm font-medium border-l-4"></div>

                    <!-- üìß SECTION 1: EMAIL LOGIN -->
                    <div id="emailLoginSection" class="mb-8 relative z-10 transition-all">
                        <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Giri≈ü Yap</h2>

                        <form id="teacherForm">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-1 ml-1">E-posta</label>
                                    <input type="email" id="teacherEmail" placeholder="mail@ornek.com" required
                                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:border-theme focus:ring-4 focus:ring-theme/10 transition-all bg-gray-50 focus:bg-white outline-none">
                                </div>

                                <div>
                                    <div class="flex justify-between items-center mb-1 ml-1">
                                        <label class="block text-gray-700 text-sm font-bold">≈ûifre</label>
                                        <a href="#" class="text-xs text-theme hover:underline font-medium">Unuttum?</a>
                                    </div>
                                    <input type="password" id="teacherPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required
                                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:border-theme focus:ring-4 focus:ring-theme/10 transition-all bg-gray-50 focus:bg-white outline-none">
                                </div>

                                <button type="submit" id="teacherLoginBtn"
                                    class="w-full bg-gray-900 text-white py-3.5 rounded-xl font-bold hover:bg-black transition-all shadow-lg hover:shadow-xl transform active:scale-[0.98] flex items-center justify-center gap-2">
                                    <span>Giri≈ü Yap</span>
                                    <span class="text-xl">üîê</span>
                                </button>
                            </div>
                        </form>

                        <div class="mt-4 text-center text-sm text-gray-500">
                            Hesabƒ±n yok mu? <a href="#" onclick="toggleRegisterMode()"
                                class="text-theme font-bold hover:underline">Kayƒ±t Ol</a>
                        </div>
                    </div>

                    <!-- üåê SECTION 2: SOCIAL LOGIN -->
                    <div class="mb-8 relative z-10">
                        <div class="relative flex justify-center text-sm mb-4">
                            <span class="px-3 bg-white text-gray-400 text-xs font-medium relative z-10">veya</span>
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-100"></div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button onclick="alert('Google ile giri≈ü yakƒ±nda!')"
                                class="flex-1 py-2.5 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors flex items-center justify-center gap-2 group">
                                <img src="https://www.svgrepo.com/show/475656/google-color.svg"
                                    class="w-5 h-5 group-hover:scale-110 transition-transform">
                                <span class="text-sm font-medium text-gray-600 group-hover:text-gray-900">Google</span>
                            </button>
                            <button onclick="alert('GitHub ile giri≈ü yakƒ±nda!')"
                                class="flex-1 py-2.5 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors flex items-center justify-center gap-2 group">
                                <img src="https://www.svgrepo.com/show/448224/github.svg"
                                    class="w-5 h-5 group-hover:scale-110 transition-transform">
                                <span class="text-sm font-medium text-gray-600 group-hover:text-gray-900">GitHub</span>
                            </button>
                        </div>
                    </div>
                    <!-- üè´ SECTION 3: CLASSROOM CODE -->
                    <div id="classroomSection" class="relative z-10 pt-6 border-t border-dashed border-gray-200">
                        <div class="text-center mb-4">
                            <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Sƒ±nƒ±f Kodu ƒ∞le Katƒ±l
                            </h3>
                        </div>

                        <form id="studentForm">
                            <!-- Classroom Code Inputs -->
                            <div class="mb-4">
                                <div class="flex gap-2 justify-center">
                                    <input type="text"
                                        class="code-box w-11 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold focus:border-theme focus:ring-4 focus:ring-theme/20 outline-none transition-all uppercase bg-gray-50 focus:bg-white"
                                        maxlength="1" data-index="0" autocomplete="off" placeholder="-">
                                    <input type="text"
                                        class="code-box w-11 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold focus:border-theme focus:ring-4 focus:ring-theme/20 outline-none transition-all uppercase bg-gray-50 focus:bg-white"
                                        maxlength="1" data-index="1" autocomplete="off" placeholder="-">
                                    <input type="text"
                                        class="code-box w-11 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold focus:border-theme focus:ring-4 focus:ring-theme/20 outline-none transition-all uppercase bg-gray-50 focus:bg-white"
                                        maxlength="1" data-index="2" autocomplete="off" placeholder="-">
                                    <input type="text"
                                        class="code-box w-11 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold focus:border-theme focus:ring-4 focus:ring-theme/20 outline-none transition-all uppercase bg-gray-50 focus:bg-white"
                                        maxlength="1" data-index="3" autocomplete="off" placeholder="-">
                                    <input type="text"
                                        class="code-box w-11 h-12 border-2 border-gray-200 rounded-lg text-center text-xl font-bold focus:border-theme focus:ring-4 focus:ring-theme/20 outline-none transition-all uppercase bg-gray-50 focus:bg-white"
                                        maxlength="1" data-index="4" autocomplete="off" placeholder="-">
                                </div>
                            </div>

                            <!-- Classroom Found Info -->
                            <div id="classroomInfo"
                                class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-xl classroom-found animate-fade-in">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-lg">
                                        üè´</div>
                                    <div>
                                        <p class="font-bold text-green-800 text-sm">Sƒ±nƒ±f Bulundu!</p>
                                        <p id="classroomDetails" class="text-green-700 text-xs"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Student Identification Section (Animated) -->
                            <div id="studentIdentifySection" class="hidden opacity-0 transition-opacity duration-500">
                                <!-- Student Name Selection -->
                                <div class="mb-3">
                                    <div id="nameSelectMode">
                                        <select id="studentSelect"
                                            class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-sm mb-1 cursor-pointer bg-white"
                                            onchange="handleStudentSelect()">
                                            <option value="">ƒ∞smini Se√ß...</option>
                                        </select>
                                        <div class="text-right">
                                            <button type="button" onclick="toggleNameInputMode()"
                                                class="text-[10px] text-theme hover:underline font-bold uppercase tracking-wide">
                                                + Listede yokum
                                            </button>
                                        </div>
                                    </div>

                                    <div id="nameInputMode" class="hidden">
                                        <input type="text" id="studentName"
                                            class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-sm mb-1"
                                            placeholder="Adƒ±nƒ± yaz..." minlength="2" maxlength="50">
                                        <div class="text-right">
                                            <button type="button" onclick="toggleNameInputMode()"
                                                class="text-[10px] text-theme hover:underline font-bold uppercase tracking-wide">
                                                ‚Üê Listeye d√∂n
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Password -->
                                <div id="studentPasswordSection" class="mb-4 hidden">
                                    <input type="password" id="studentPassword"
                                        class="w-full px-3 py-2.5 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-sm"
                                        placeholder="Sƒ±nƒ±f ≈üifresi...">
                                </div>

                                <button type="submit" id="studentLoginBtn"
                                    class="w-full bg-theme text-white py-3 rounded-xl font-bold text-sm hover:brightness-110 transition-all flex items-center justify-center gap-2 shadow-md">
                                    <span>Sƒ±nƒ±fa Katƒ±l</span>
                                    <span class="text-lg">üöÄ</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Register Form Overlay (Simple Implementation) -->
                    <div id="registerSection" class="hidden absolute inset-0 bg-white p-8 z-20 flex flex-col">
                        <div class="flex items-center mb-6">
                            <button type="button" onclick="toggleRegisterMode()"
                                class="p-2 -ml-2 hover:bg-gray-100 rounded-full transition-colors mr-2">
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <h2 class="text-xl font-bold text-gray-800">Kayƒ±t Ol</h2>
                        </div>

                        <form id="registerForm" class="flex-grow">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-1">Ad Soyad</label>
                                    <input type="text" id="regName" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z" required
                                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:border-theme bg-gray-50 focus:bg-white outline-none">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-1">E-posta</label>
                                    <input type="email" id="regEmail" placeholder="mail@ornek.com" required
                                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:border-theme bg-gray-50 focus:bg-white outline-none">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-1">≈ûifre</label>
                                    <input type="password" id="regPassword" placeholder="En az 6 karakter" required
                                        minlength="6"
                                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:border-theme bg-gray-50 focus:bg-white outline-none">
                                </div>
                                <button type="submit" id="regBtn"
                                    class="w-full bg-theme text-white py-3.5 rounded-xl font-bold hover:brightness-110 shadow-lg mt-4">
                                    Hesap Olu≈ütur
                                </button>
                            </div>
                        </form>
                    </div>
                </div> <!-- End of auth-card -->
            </div>
        </div>

        <!-- Guest/Back Link (Outside Card) -->
        <div class="mt-8 text-center">
            <a href="index.html" class="text-gray-500 hover:text-gray-800 text-sm font-medium transition-colors">
                ‚Üê Misafir olarak devam et
            </a>
        </div>

        <!-- Footer -->
        <footer class="py-4 text-center text-sm text-gray-500">
            <p>¬© 2024 Yeti LAB - ƒ∞√ßindeki Yeti'leri Ke≈üfet</p>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="modules/supabaseClient.js"></script>
    <script src="modules/auth.js"></script>
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase
            SupabaseClient.init();

            // Check URL params - if force=true, don't redirect
            const urlParams = new URLSearchParams(window.location.search);
            const forceShow = urlParams.get('force') === 'true';

            // Check for OAuth callback (URL contains access_token in hash)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            if (hashParams.get('access_token')) {
                // OAuth callback - wait for session to be established
                showAlert('Giri≈ü yapƒ±lƒ±yor, l√ºtfen bekleyin...', 'info');

                // Give Supabase time to process the token
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Check session again
                const session = await Auth.checkSession();
                if (session) {
                    showAlert('Giri≈ü ba≈üarƒ±lƒ±! Y√∂nlendiriliyorsunuz...', 'success');
                    setTimeout(() => {
                        // Clear the hash and redirect to teacher panel
                        window.location.href = 'teacher.html';
                    }, 500);
                    return;
                }
            }

            // Check if already logged in
            const session = await Auth.checkSession();
            if (session && !forceShow) {
                window.location.href = 'index.html';
                return;
            }

            // Check student session
            if (Auth.checkStudentSession() && !forceShow) {
                window.location.href = 'index.html';
                return;
            }

            // If logged in but force=true, show logout option
            if (session && forceShow) {
                const userName = session.user?.user_metadata?.full_name ||
                    session.user?.user_metadata?.name ||
                    session.user?.email || 'Kullanƒ±cƒ±';
                showAlert(`Zaten giri≈ü yapmƒ±≈üsƒ±nƒ±z: ${userName}`, 'success');

                // Replace guest link with logout
                const guestLink = document.querySelector('.mt-6.pt-6');
                guestLink.innerHTML = `
                    <button onclick="logout()" class="w-full bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 transition-all mb-3">
                        üö™ √áƒ±kƒ±≈ü Yap
                    </button>
                    <a href="index.html" class="text-gray-500 hover:text-theme transition-colors">‚Üê Ana sayfaya d√∂n</a>
                `;
            }

            // Setup code inputs
            setupCodeInputs();

            // Setup forms
            setupForms();
        });

        // Logout function
        async function logout() {
            try {
                await Auth.signOut();
                Auth.studentLogout();
                showAlert('√áƒ±kƒ±≈ü yapƒ±ldƒ±!', 'success');
                setTimeout(() => location.reload(), 500);
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }

        // Toggle Register Mode Overlay
        function toggleRegisterMode() {
            const section = document.getElementById('registerSection');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                // Allow browser to render hidden removal before adding opacity class if needed
                requestAnimationFrame(() => {
                    section.classList.add('animate-fade-in');
                });
            } else {
                section.classList.add('hidden');
            }
        }

        // Code input handling
        function setupCodeInputs() {
            const inputs = document.querySelectorAll('.code-box');

            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    e.target.value = value;

                    if (value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }

                    checkClassroomCode();
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });

                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const paste = e.clipboardData.getData('text').toUpperCase().replace(/[^A-Z0-9]/g, '');

                    for (let i = 0; i < Math.min(paste.length, 5); i++) {
                        inputs[i].value = paste[i];
                    }

                    if (paste.length >= 5) {
                        inputs[4].focus();
                        checkClassroomCode();
                    }
                });
            });
        }

        // Get code from inputs
        function getClassroomCode() {
            const inputs = document.querySelectorAll('.code-box');
            return Array.from(inputs).map(i => i.value).join('');
        }

        // Check classroom code
        let currentClassroomData = null; // Store classroom data for later use
        let classroomStudents = [];

        async function checkClassroomCode() {
            const code = getClassroomCode();
            const infoBox = document.getElementById('classroomInfo');
            const details = document.getElementById('classroomDetails');
            const passwordSection = document.getElementById('studentPasswordSection');
            const passwordInput = document.getElementById('studentPassword');
            const studentSelect = document.getElementById('studentSelect');

            if (code.length !== 5) {
                infoBox.classList.add('hidden');
                passwordSection.classList.add('hidden');
                passwordInput.required = false;
                currentClassroomData = null;
                classroomStudents = [];
                studentSelect.innerHTML = '<option value="">ƒ∞smini Se√ß...</option>';
                return;
            }

            try {
                // Get classroom data
                const { data, error } = await SupabaseClient.getClient()
                    .from('classrooms')
                    .select('id, name, requires_password, user_profiles(full_name)')
                    .eq('code', code)
                    .eq('is_active', true)
                    .maybeSingle();

                if (data) {
                    currentClassroomData = data;
                    infoBox.classList.remove('hidden');

                    // Show password lock indicator if required
                    const lockIcon = data.requires_password ? ' üîí' : '';
                    details.textContent = `${data.name}${lockIcon} - ${data.user_profiles?.full_name || '√ñƒüretmen'}`;

                    // Fetch students for this classroom
                    const { data: students, error: studentsError } = await SupabaseClient.getClient()
                        .from('students')
                        .select('id, display_name, password')
                        .eq('classroom_id', data.id)
                        .order('display_name');

                    if (students && students.length > 0) {
                        classroomStudents = students;
                        studentSelect.innerHTML = '<option value="">ƒ∞smini Se√ß...</option>' +
                            students.map(s => `<option value="${s.id}">${escapeHtml(s.display_name)}</option>`).join('');

                        // Default to selection mode if students exist
                        document.getElementById('nameSelectMode').classList.remove('hidden');
                        document.getElementById('nameInputMode').classList.add('hidden');
                    } else {
                        // No students, force input mode
                        toggleNameInputMode(true);
                    }

                    // Reset password section initially (wait for student selection)
                    passwordSection.classList.add('hidden');
                    passwordInput.required = false;

                } else {
                    infoBox.classList.add('hidden');
                    passwordSection.classList.add('hidden');
                    passwordInput.required = false;
                    currentClassroomData = null;
                }
            } catch (err) {
                console.warn('Code check error:', err);
                infoBox.classList.add('hidden');
            }
        }

        function toggleNameInputMode(forceInput = false) {
            const selectMode = document.getElementById('nameSelectMode');
            const inputMode = document.getElementById('nameInputMode');
            const studentSelect = document.getElementById('studentSelect');
            const studentName = document.getElementById('studentName');

            if (forceInput || !inputMode.classList.contains('hidden')) {
                // Switch to Select Mode
                if (!forceInput) {
                    selectMode.classList.remove('hidden');
                    inputMode.classList.add('hidden');
                    studentName.value = ''; // clear manual input
                } else {
                    // Force Input
                    selectMode.classList.add('hidden');
                    inputMode.classList.remove('hidden');
                    studentSelect.value = ''; // clear selection
                }
            } else {
                // Switch to Input Mode
                selectMode.classList.add('hidden');
                inputMode.classList.remove('hidden');
                studentSelect.value = ''; // clear selection
            }

            // Reset password field visibility when switching modes
            handleStudentSelect();
        }

        function handleStudentSelect() {
            const studentId = document.getElementById('studentSelect').value;
            const passwordSection = document.getElementById('studentPasswordSection');
            const passwordInput = document.getElementById('studentPassword');

            // If manual input mode is active or no student selected
            if (document.getElementById('nameInputMode').classList.contains('hidden') === false) {
                // In manual mode, obey classroom rules
                if (currentClassroomData?.requires_password) {
                    passwordSection.classList.remove('hidden');
                    passwordInput.required = true;
                } else {
                    passwordSection.classList.add('hidden');
                    passwordInput.required = false;
                }
                return;
            }

            // In selection mode
            if (!studentId) {
                passwordSection.classList.add('hidden');
                passwordInput.required = false;
                return;
            }

            const student = classroomStudents.find(s => s.id === studentId);

            // If student has a specific password or classroom requires it
            if ((student && student.password) || (currentClassroomData?.requires_password)) {
                passwordSection.classList.remove('hidden');
                passwordInput.required = true;

                // Update placeholder based on requirement
                if (student && student.password) {
                    passwordInput.placeholder = "√ñƒürenci ≈üifreni gir...";
                } else {
                    passwordInput.placeholder = "Sƒ±nƒ±f ≈üifresini gir...";
                }
            } else {
                passwordSection.classList.add('hidden');
                passwordInput.required = false;
            }
        }

        // Setup forms
        function setupForms() {
            // Student form
            document.getElementById('studentForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const code = getClassroomCode();
                let name = "";
                let studentId = null;

                // Determine name based on mode
                if (document.getElementById('nameInputMode').classList.contains('hidden')) {
                    // Selection Mode
                    const select = document.getElementById('studentSelect');
                    if (select.value) {
                        studentId = select.value;
                        const selectedStudent = classroomStudents.find(s => s.id === studentId);
                        name = selectedStudent ? selectedStudent.display_name : "";
                    }
                } else {
                    // Manual Input Mode
                    name = document.getElementById('studentName').value.trim();
                }

                const password = document.getElementById('studentPassword').value.trim();
                const btn = document.getElementById('studentLoginBtn');

                if (code.length !== 5) {
                    showAlert('L√ºtfen 5 haneli sƒ±nƒ±f kodunu gir', 'error');
                    return;
                }

                if (!name || name.length < 2) {
                    showAlert('L√ºtfen bir isim se√ß veya yaz', 'error');
                    return;
                }


                // Check password if required (based on visibility)
                if (!document.getElementById('studentPasswordSection').classList.contains('hidden')) {
                    if (!password) {
                        showAlert('L√ºtfen ≈üifreni gir.', 'error');
                        document.getElementById('studentPassword').focus();
                        return;
                    }
                }

                setLoading(btn, true);

                try {
                    // Pass password to studentLogin if provided
                    await Auth.studentLogin(code, name, password);
                    showAlert('Giri≈ü ba≈üarƒ±lƒ±! Y√∂nlendiriliyorsun...', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } catch (err) {
                    showAlert(err.message, 'error');
                    setLoading(btn, false);
                }
            });

            // Teacher form
            document.getElementById('teacherForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const email = document.getElementById('teacherEmail').value;
                const password = document.getElementById('teacherPassword').value;
                const btn = document.getElementById('teacherLoginBtn');

                setLoading(btn, true);

                try {
                    await Auth.signInWithEmail(email, password);
                    showAlert('Giri≈ü ba≈üarƒ±lƒ±! Y√∂nlendiriliyorsun...', 'success');
                    setTimeout(() => {
                        window.location.href = 'teacher.html';
                    }, 1000);
                } catch (err) {
                    showAlert(err.message, 'error');
                    setLoading(btn, false);
                }
            });
        }

        // OAuth logins
        async function teacherGoogleLogin(btn) {
            if (btn && btn.disabled) return; // Double-click protection
            setLoading(btn, true);
            try {
                await Auth.signInWithGoogle();
                // Auth redirect will happen, keep loading
            } catch (err) {
                showAlert(err.message, 'error');
                setLoading(btn, false);
            }
        }

        async function teacherGitHubLogin(btn) {
            if (btn && btn.disabled) return; // Double-click protection
            setLoading(btn, true);
            try {
                await Auth.signInWithGitHub();
                // Auth redirect will happen, keep loading
            } catch (err) {
                showAlert(err.message, 'error');
                setLoading(btn, false);
            }
        }

        async function studentGoogleLogin(btn) {
            if (btn && btn.disabled) return; // Double-click protection
            setLoading(btn, true);
            try {
                await Auth.signInWithGoogle();
                // Auth redirect will happen, keep loading
            } catch (err) {
                showAlert(err.message, 'error');
                setLoading(btn, false);
            }
        }

        function toggleTeacherSignup() {
            showAlert('Kayƒ±t olmak i√ßin Google veya GitHub ile devam edin.', 'info');
        }

        // Alert helpers
        function showAlert(message, type) {
            const alert = document.getElementById('alertBox');
            alert.className = 'mb-4 p-4 rounded-xl text-sm font-medium';

            if (type === 'error') {
                alert.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
            } else if (type === 'success') {
                alert.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
            } else {
                alert.classList.add('bg-blue-50', 'text-blue-700', 'border', 'border-blue-200');
            }

            alert.textContent = message;
            alert.classList.remove('hidden');
        }

        function hideAlert() {
            document.getElementById('alertBox').classList.add('hidden');
        }

        // Loading state
        function setLoading(btn, loading) {
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Y√ºkleniyor...';
            } else {
                btn.disabled = false;
                if (btn.id === 'studentLoginBtn') {
                    btn.innerHTML = '<span>Derse Ba≈üla</span><span class="text-xl">üöÄ</span>';
                } else {
                    btn.innerHTML = 'Giri≈ü Yap';
                }
            }
        }
    </script>
</body>

</html>