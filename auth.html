<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giri≈ü Yap - Yeti LAB</title>
    <meta name="description" content="Yeti LAB eƒüitim platformuna giri≈ü yapƒ±n. √ñƒürenci veya √∂ƒüretmen olarak ba≈ülayƒ±n.">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="img/favicon.svg">
    <link rel="apple-touch-icon" href="img/favicon.svg">

    <!-- Tailwind CSS - CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Main Styles (includes Nunito font) -->
    <link rel="stylesheet" href="styles/main.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="modules/toast.js"></script>

    <style>
        /* Auth page specific styles */
        .auth-bg {
            background: linear-gradient(135deg, #f0fdfa 0%, #ecfdf5 50%, #f0f9ff 100%);
            min-height: 100vh;
        }

        body.dark-mode .auth-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .auth-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(0, 0, 0, 0.05);
        }

        body.dark-mode .auth-card {
            background: rgba(30, 41, 59, 0.95);
        }

        /* Code input boxes */
        .code-box {
            width: 56px;
            height: 64px;
            font-size: 1.75rem;
            font-weight: 800;
            text-align: center;
            text-transform: uppercase;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .code-box:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 3px rgba(0, 151, 156, 0.2);
        }

        body.dark-mode .code-box {
            background: #1e293b;
            border-color: #475569;
            color: #fff;
        }

        /* OAuth buttons */
        .btn-oauth {
            transition: all 0.2s;
        }

        .btn-oauth:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Floating elements animation */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .floating-icon {
            animation: float 6s ease-in-out infinite;
        }

        .floating-icon:nth-child(2) {
            animation-delay: 1s;
        }

        .floating-icon:nth-child(3) {
            animation-delay: 2s;
        }

        /* Tab styles */
        .auth-tab {
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: var(--theme-color);
            color: white;
        }

        /* Classroom info animation */
        .classroom-found {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div class="auth-bg flex flex-col min-h-screen">
        <!-- Floating decorations -->
        <div class="fixed inset-0 pointer-events-none overflow-hidden">
            <div class="floating-icon absolute text-6xl opacity-20" style="top: 10%; left: 10%;">ü§ñ</div>
            <div class="floating-icon absolute text-6xl opacity-20" style="top: 20%; right: 15%;">üí°</div>
            <div class="floating-icon absolute text-6xl opacity-20" style="bottom: 20%; left: 20%;">‚ö°</div>
            <div class="floating-icon absolute text-6xl opacity-20" style="bottom: 30%; right: 10%;">üîß</div>
        </div>

        <!-- Main Content -->
        <div class="flex-grow flex items-center justify-center px-4 py-8 relative z-10">
            <div class="w-full max-w-md">
                <!-- Logo -->
                <div class="text-center mb-8">
                    <div class="flex items-center justify-center mb-4 cursor-pointer"
                        onclick="window.location.href='index.html'">
                        <img src="img/logo.svg" alt="Yeti LAB" class="w-16 h-16 mr-3">
                        <div class="brand-logo">
                            <h1 class="text-3xl text-gray-800 leading-tight flex items-baseline gap-1">
                                <span>Yeti</span><span class="brand-lab text-theme">LAB</span>
                            </h1>
                        </div>
                    </div>
                    <p class="text-gray-600 text-lg">Kodlama ve Robotik Eƒüitim Platformu</p>
                </div>

                <!-- Auth Card -->
                <div class="auth-card rounded-2xl p-8">
                    <!-- Tabs -->
                    <div class="flex gap-2 mb-6 bg-gray-100 p-1 rounded-xl">
                        <button
                            class="auth-tab flex-1 py-3 px-4 rounded-lg font-bold flex items-center justify-center gap-2 active"
                            data-tab="student">
                            <span class="text-xl">üéì</span>
                            <span>√ñƒürenci</span>
                        </button>
                        <button
                            class="auth-tab flex-1 py-3 px-4 rounded-lg font-bold flex items-center justify-center gap-2 text-gray-600"
                            data-tab="teacher">
                            <span class="text-xl">üë®‚Äçüè´</span>
                            <span>√ñƒüretmen</span>
                        </button>
                    </div>

                    <!-- Alert Box -->
                    <div id="alertBox" class="hidden mb-4 p-4 rounded-xl text-sm font-medium"></div>

                    <!-- Student Panel -->
                    <div id="studentPanel" class="auth-panel">
                        <form id="studentForm">
                            <!-- Classroom Code -->
                            <div class="mb-6">
                                <label class="block text-gray-700 font-bold mb-3 text-center">Sƒ±nƒ±f Kodu</label>
                                <div class="flex gap-2 justify-center">
                                    <input type="text" class="code-box" maxlength="1" data-index="0" autocomplete="off">
                                    <input type="text" class="code-box" maxlength="1" data-index="1" autocomplete="off">
                                    <input type="text" class="code-box" maxlength="1" data-index="2" autocomplete="off">
                                    <input type="text" class="code-box" maxlength="1" data-index="3" autocomplete="off">
                                    <input type="text" class="code-box" maxlength="1" data-index="4" autocomplete="off">
                                </div>
                                <p class="text-gray-500 text-sm text-center mt-3">
                                    √ñƒüretmeninden aldƒ±ƒüƒ±n 5 harfli kodu gir
                                </p>
                            </div>

                            <!-- Classroom Found Info -->
                            <div id="classroomInfo"
                                class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-xl classroom-found">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">‚úÖ</span>
                                    <div>
                                        <p class="font-bold text-green-800">Sƒ±nƒ±f Bulundu!</p>
                                        <p id="classroomDetails" class="text-green-700 text-sm"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Student Name Selection -->
                            <div class="mb-4">
                                <label class="block text-gray-700 font-bold mb-2">ƒ∞smin</label>

                                <!-- Selection Mode -->
                                <div id="nameSelectMode">
                                    <select id="studentSelect"
                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-lg mb-2 cursor-pointer"
                                        onchange="handleStudentSelect()">
                                        <option value="">ƒ∞smini Se√ß...</option>
                                    </select>
                                    <div class="text-right">
                                        <button type="button" onclick="toggleNameInputMode()"
                                            class="text-sm text-theme hover:underline font-medium">
                                            Listede yokum, ismimi yazmak istiyorum
                                        </button>
                                    </div>
                                </div>

                                <!-- Input Mode (Hidden by default) -->
                                <div id="nameInputMode" class="hidden">
                                    <input type="text" id="studentName"
                                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-lg mb-2"
                                        placeholder="Adƒ±nƒ± yaz..." minlength="2" maxlength="50">
                                    <div class="text-right">
                                        <button type="button" onclick="toggleNameInputMode()"
                                            class="text-sm text-theme hover:underline font-medium">
                                            Listeden se√ß
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Student Password (hidden by default, shown when classroom requires password) -->
                            <div id="studentPasswordSection" class="mb-6 hidden">
                                <label class="block text-gray-700 font-bold mb-2">
                                    <span class="flex items-center gap-2">
                                        üîí ≈ûifre
                                        <span class="text-xs font-normal text-gray-500">(√ñƒüretmeninden aldƒ±ƒüƒ±n
                                            ≈üifre)</span>
                                    </span>
                                </label>
                                <input type="password" id="studentPassword"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-lg"
                                    placeholder="≈ûifreni gir...">
                                <p class="text-xs text-gray-500 mt-1">Bu sƒ±nƒ±f ≈üifre ile korunuyor</p>
                            </div>

                            <!-- Submit Button -->
                            <button type="submit" id="studentLoginBtn"
                                class="w-full bg-theme text-white py-4 rounded-xl font-bold text-lg hover:brightness-110 transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
                                <span>Derse Ba≈üla</span>
                                <span class="text-xl">üöÄ</span>
                            </button>
                        </form>

                        <!-- Divider -->
                        <div class="flex items-center my-6">
                            <div class="flex-1 border-t border-gray-200"></div>
                            <span class="px-4 text-gray-400 text-sm">veya</span>
                            <div class="flex-1 border-t border-gray-200"></div>
                        </div>

                        <!-- Google Login for Students -->
                        <button id="btn-student-google" onclick="studentGoogleLogin(this)"
                            class="btn-oauth w-full py-3 px-4 border-2 border-gray-200 rounded-xl flex items-center justify-center gap-3 font-medium hover:bg-gray-50">
                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#EA4335"
                                    d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z" />
                            </svg>
                            <span>Google ile Devam Et</span>
                        </button>
                    </div>

                    <!-- Teacher Panel -->
                    <div id="teacherPanel" class="auth-panel hidden">
                        <!-- OAuth Buttons -->
                        <div class="space-y-3 mb-6">
                            <button id="btn-teacher-google" onclick="teacherGoogleLogin(this)"
                                class="btn-oauth w-full py-3 px-4 border-2 border-red-200 bg-white rounded-xl flex items-center justify-center gap-3 font-medium hover:bg-red-50">
                                <svg class="w-5 h-5" viewBox="0 0 24 24">
                                    <path fill="#EA4335"
                                        d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z" />
                                </svg>
                                <span>Google ile Giri≈ü Yap</span>
                            </button>

                            <button id="btn-teacher-github" onclick="teacherGitHubLogin(this)"
                                class="btn-oauth w-full py-3 px-4 border-2 border-gray-300 bg-gray-900 text-white rounded-xl flex items-center justify-center gap-3 font-medium hover:bg-gray-800">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z" />
                                </svg>
                                <span>GitHub ile Giri≈ü Yap</span>
                            </button>
                        </div>

                        <!-- Divider -->
                        <div class="flex items-center my-6">
                            <div class="flex-1 border-t border-gray-200"></div>
                            <span class="px-4 text-gray-400 text-sm">veya e-posta ile</span>
                            <div class="flex-1 border-t border-gray-200"></div>
                        </div>

                        <!-- Email/Password Form -->
                        <form id="teacherForm">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-bold mb-2">E-posta</label>
                                <input type="email" id="teacherEmail"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all"
                                    placeholder="ornek@okul.edu.tr" required>
                            </div>

                            <div class="mb-6">
                                <label class="block text-gray-700 font-bold mb-2">≈ûifre</label>
                                <input type="password" id="teacherPassword"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                            </div>

                            <button type="submit" id="teacherLoginBtn"
                                class="w-full bg-theme text-white py-4 rounded-xl font-bold text-lg hover:brightness-110 transition-all shadow-lg">
                                Giri≈ü Yap
                            </button>
                        </form>

                        <p class="text-center mt-4 text-gray-500">
                            Hesabƒ±nƒ±z yok mu?
                            <a href="#" onclick="toggleTeacherSignup()"
                                class="text-theme font-bold hover:underline">Kayƒ±t Ol</a>
                        </p>
                    </div>

                    <!-- Guest/Back Link -->
                    <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                        <a href="index.html" class="text-gray-500 hover:text-theme transition-colors">
                            ‚Üê Misafir olarak devam et
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-4 text-center text-sm text-gray-500">
            <p>¬© 2024 Yeti LAB - ƒ∞√ßindeki Yeti'leri Ke≈üfet</p>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="modules/supabaseClient.js"></script>
    <script src="modules/auth.js"></script>
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase
            SupabaseClient.init();

            // Check URL params - if force=true, don't redirect
            const urlParams = new URLSearchParams(window.location.search);
            const forceShow = urlParams.get('force') === 'true';

            // Check for OAuth callback (URL contains access_token in hash)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            if (hashParams.get('access_token')) {
                // OAuth callback - wait for session to be established
                showAlert('Giri≈ü yapƒ±lƒ±yor, l√ºtfen bekleyin...', 'info');

                // Give Supabase time to process the token
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Check session again
                const session = await Auth.checkSession();
                if (session) {
                    showAlert('Giri≈ü ba≈üarƒ±lƒ±! Y√∂nlendiriliyorsunuz...', 'success');
                    setTimeout(() => {
                        // Clear the hash and redirect to teacher panel
                        window.location.href = 'teacher.html';
                    }, 500);
                    return;
                }
            }

            // Check if already logged in
            const session = await Auth.checkSession();
            if (session && !forceShow) {
                window.location.href = 'index.html';
                return;
            }

            // Check student session
            if (Auth.checkStudentSession() && !forceShow) {
                window.location.href = 'index.html';
                return;
            }

            // If logged in but force=true, show logout option
            if (session && forceShow) {
                const userName = session.user?.user_metadata?.full_name ||
                    session.user?.user_metadata?.name ||
                    session.user?.email || 'Kullanƒ±cƒ±';
                showAlert(`Zaten giri≈ü yapmƒ±≈üsƒ±nƒ±z: ${userName}`, 'success');

                // Replace guest link with logout
                const guestLink = document.querySelector('.mt-6.pt-6');
                guestLink.innerHTML = `
                    <button onclick="logout()" class="w-full bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 transition-all mb-3">
                        üö™ √áƒ±kƒ±≈ü Yap
                    </button>
                    <a href="index.html" class="text-gray-500 hover:text-theme transition-colors">‚Üê Ana sayfaya d√∂n</a>
                `;
            }

            // Setup tabs
            setupTabs();

            // Setup code inputs
            setupCodeInputs();

            // Setup forms
            setupForms();
        });

        // Logout function
        async function logout() {
            try {
                await Auth.signOut();
                Auth.studentLogout();
                showAlert('√áƒ±kƒ±≈ü yapƒ±ldƒ±!', 'success');
                setTimeout(() => location.reload(), 500);
            } catch (err) {
                showAlert(err.message, 'error');
            }
        }

        // Tab switching
        function setupTabs() {
            const tabs = document.querySelectorAll('.auth-tab');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.dataset.tab;

                    // Update tabs
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.classList.add('text-gray-600');
                    });
                    tab.classList.add('active');
                    tab.classList.remove('text-gray-600');

                    // Update panels
                    document.querySelectorAll('.auth-panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(target + 'Panel').classList.remove('hidden');

                    hideAlert();
                });
            });
        }

        // Code input handling
        function setupCodeInputs() {
            const inputs = document.querySelectorAll('.code-box');

            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    e.target.value = value;

                    if (value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }

                    checkClassroomCode();
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });

                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const paste = e.clipboardData.getData('text').toUpperCase().replace(/[^A-Z0-9]/g, '');

                    for (let i = 0; i < Math.min(paste.length, 5); i++) {
                        inputs[i].value = paste[i];
                    }

                    if (paste.length >= 5) {
                        inputs[4].focus();
                        checkClassroomCode();
                    }
                });
            });
        }

        // Get code from inputs
        function getClassroomCode() {
            const inputs = document.querySelectorAll('.code-box');
            return Array.from(inputs).map(i => i.value).join('');
        }

        // Check classroom code
        let currentClassroomData = null; // Store classroom data for later use
        let classroomStudents = [];

        async function checkClassroomCode() {
            const code = getClassroomCode();
            const infoBox = document.getElementById('classroomInfo');
            const details = document.getElementById('classroomDetails');
            const passwordSection = document.getElementById('studentPasswordSection');
            const passwordInput = document.getElementById('studentPassword');
            const studentSelect = document.getElementById('studentSelect');

            if (code.length !== 5) {
                infoBox.classList.add('hidden');
                passwordSection.classList.add('hidden');
                passwordInput.required = false;
                currentClassroomData = null;
                classroomStudents = [];
                studentSelect.innerHTML = '<option value="">ƒ∞smini Se√ß...</option>';
                return;
            }

            try {
                // Get classroom data
                const { data, error } = await SupabaseClient.getClient()
                    .from('classrooms')
                    .select('id, name, requires_password, user_profiles(full_name)')
                    .eq('code', code)
                    .eq('is_active', true)
                    .maybeSingle();

                if (data) {
                    currentClassroomData = data;
                    infoBox.classList.remove('hidden');

                    // Show password lock indicator if required
                    const lockIcon = data.requires_password ? ' üîí' : '';
                    details.textContent = `${data.name}${lockIcon} - ${data.user_profiles?.full_name || '√ñƒüretmen'}`;

                    // Fetch students for this classroom
                    const { data: students, error: studentsError } = await SupabaseClient.getClient()
                        .from('students')
                        .select('id, display_name, password')
                        .eq('classroom_id', data.id)
                        .order('display_name');

                    if (students && students.length > 0) {
                        classroomStudents = students;
                        studentSelect.innerHTML = '<option value="">ƒ∞smini Se√ß...</option>' +
                            students.map(s => `<option value="${s.id}">${escapeHtml(s.display_name)}</option>`).join('');

                        // Default to selection mode if students exist
                        document.getElementById('nameSelectMode').classList.remove('hidden');
                        document.getElementById('nameInputMode').classList.add('hidden');
                    } else {
                        // No students, force input mode
                        toggleNameInputMode(true);
                    }

                    // Reset password section initially (wait for student selection)
                    passwordSection.classList.add('hidden');
                    passwordInput.required = false;

                } else {
                    infoBox.classList.add('hidden');
                    passwordSection.classList.add('hidden');
                    passwordInput.required = false;
                    currentClassroomData = null;
                }
            } catch (err) {
                console.warn('Code check error:', err);
                infoBox.classList.add('hidden');
            }
        }

        function toggleNameInputMode(forceInput = false) {
            const selectMode = document.getElementById('nameSelectMode');
            const inputMode = document.getElementById('nameInputMode');
            const studentSelect = document.getElementById('studentSelect');
            const studentName = document.getElementById('studentName');

            if (forceInput || !inputMode.classList.contains('hidden')) {
                // Switch to Select Mode
                if (!forceInput) {
                    selectMode.classList.remove('hidden');
                    inputMode.classList.add('hidden');
                    studentName.value = ''; // clear manual input
                } else {
                    // Force Input
                    selectMode.classList.add('hidden');
                    inputMode.classList.remove('hidden');
                    studentSelect.value = ''; // clear selection
                }
            } else {
                // Switch to Input Mode
                selectMode.classList.add('hidden');
                inputMode.classList.remove('hidden');
                studentSelect.value = ''; // clear selection
            }

            // Reset password field visibility when switching modes
            handleStudentSelect();
        }

        function handleStudentSelect() {
            const studentId = document.getElementById('studentSelect').value;
            const passwordSection = document.getElementById('studentPasswordSection');
            const passwordInput = document.getElementById('studentPassword');

            // If manual input mode is active or no student selected
            if (document.getElementById('nameInputMode').classList.contains('hidden') === false) {
                // In manual mode, obey classroom rules
                if (currentClassroomData?.requires_password) {
                    passwordSection.classList.remove('hidden');
                    passwordInput.required = true;
                } else {
                    passwordSection.classList.add('hidden');
                    passwordInput.required = false;
                }
                return;
            }

            // In selection mode
            if (!studentId) {
                passwordSection.classList.add('hidden');
                passwordInput.required = false;
                return;
            }

            const student = classroomStudents.find(s => s.id === studentId);

            // If student has a specific password or classroom requires it
            if ((student && student.password) || (currentClassroomData?.requires_password)) {
                passwordSection.classList.remove('hidden');
                passwordInput.required = true;

                // Update placeholder based on requirement
                if (student && student.password) {
                    passwordInput.placeholder = "√ñƒürenci ≈üifreni gir...";
                } else {
                    passwordInput.placeholder = "Sƒ±nƒ±f ≈üifresini gir...";
                }
            } else {
                passwordSection.classList.add('hidden');
                passwordInput.required = false;
            }
        }

        // Setup forms
        function setupForms() {
            // Student form
            document.getElementById('studentForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const code = getClassroomCode();
                let name = "";
                let studentId = null;

                // Determine name based on mode
                if (document.getElementById('nameInputMode').classList.contains('hidden')) {
                    // Selection Mode
                    const select = document.getElementById('studentSelect');
                    if (select.value) {
                        studentId = select.value;
                        const selectedStudent = classroomStudents.find(s => s.id === studentId);
                        name = selectedStudent ? selectedStudent.display_name : "";
                    }
                } else {
                    // Manual Input Mode
                    name = document.getElementById('studentName').value.trim();
                }

                const password = document.getElementById('studentPassword').value.trim();
                const btn = document.getElementById('studentLoginBtn');

                if (code.length !== 5) {
                    showAlert('L√ºtfen 5 haneli sƒ±nƒ±f kodunu gir', 'error');
                    return;
                }

                if (!name || name.length < 2) {
                    showAlert('L√ºtfen bir isim se√ß veya yaz', 'error');
                    return;
                }


                // Check password if required (based on visibility)
                if (!document.getElementById('studentPasswordSection').classList.contains('hidden')) {
                    if (!password) {
                        showAlert('L√ºtfen ≈üifreni gir.', 'error');
                        document.getElementById('studentPassword').focus();
                        return;
                    }
                }

                setLoading(btn, true);

                try {
                    // Pass password to studentLogin if provided
                    await Auth.studentLogin(code, name, password);
                    showAlert('Giri≈ü ba≈üarƒ±lƒ±! Y√∂nlendiriliyorsun...', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                } catch (err) {
                    showAlert(err.message, 'error');
                    setLoading(btn, false);
                }
            });

            // Teacher form
            document.getElementById('teacherForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const email = document.getElementById('teacherEmail').value;
                const password = document.getElementById('teacherPassword').value;
                const btn = document.getElementById('teacherLoginBtn');

                setLoading(btn, true);

                try {
                    await Auth.signInWithEmail(email, password);
                    showAlert('Giri≈ü ba≈üarƒ±lƒ±! Y√∂nlendiriliyorsun...', 'success');
                    setTimeout(() => {
                        window.location.href = 'teacher.html';
                    }, 1000);
                } catch (err) {
                    showAlert(err.message, 'error');
                    setLoading(btn, false);
                }
            });
        }

        // OAuth logins
        async function teacherGoogleLogin(btn) {
            if (btn && btn.disabled) return; // Double-click protection
            setLoading(btn, true);
            try {
                await Auth.signInWithGoogle();
                // Auth redirect will happen, keep loading
            } catch (err) {
                showAlert(err.message, 'error');
                setLoading(btn, false);
            }
        }

        async function teacherGitHubLogin(btn) {
            if (btn && btn.disabled) return; // Double-click protection
            setLoading(btn, true);
            try {
                await Auth.signInWithGitHub();
                // Auth redirect will happen, keep loading
            } catch (err) {
                showAlert(err.message, 'error');
                setLoading(btn, false);
            }
        }

        async function studentGoogleLogin(btn) {
            if (btn && btn.disabled) return; // Double-click protection
            setLoading(btn, true);
            try {
                await Auth.signInWithGoogle();
                // Auth redirect will happen, keep loading
            } catch (err) {
                showAlert(err.message, 'error');
                setLoading(btn, false);
            }
        }

        function toggleTeacherSignup() {
            showAlert('Kayƒ±t olmak i√ßin Google veya GitHub ile devam edin.', 'info');
        }

        // Alert helpers
        function showAlert(message, type) {
            const alert = document.getElementById('alertBox');
            alert.className = 'mb-4 p-4 rounded-xl text-sm font-medium';

            if (type === 'error') {
                alert.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
            } else if (type === 'success') {
                alert.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
            } else {
                alert.classList.add('bg-blue-50', 'text-blue-700', 'border', 'border-blue-200');
            }

            alert.textContent = message;
            alert.classList.remove('hidden');
        }

        function hideAlert() {
            document.getElementById('alertBox').classList.add('hidden');
        }

        // Loading state
        function setLoading(btn, loading) {
            if (loading) {
                btn.disabled = true;
                btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Y√ºkleniyor...';
            } else {
                btn.disabled = false;
                if (btn.id === 'studentLoginBtn') {
                    btn.innerHTML = '<span>Derse Ba≈üla</span><span class="text-xl">üöÄ</span>';
                } else {
                    btn.innerHTML = 'Giri≈ü Yap';
                }
            }
        }
    </script>
</body>

</html>