<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Tamamla - Yeti LAB</title>
    <meta name="description" content="Yeti LAB profilinizi tamamlayƒ±n">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="img/favicon.svg">
    <link rel="apple-touch-icon" href="img/favicon.svg">

    <!-- Tailwind CSS -->
    <link href="styles/output.css" rel="stylesheet">

    <!-- Main Styles -->
    <link rel="stylesheet" href="styles/main.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        .profile-bg {
            background: linear-gradient(135deg, #f0fdfa 0%, #ecfdf5 50%, #f0f9ff 100%);
            min-height: 100vh;
        }

        body.dark-mode .profile-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .role-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .role-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.2);
        }

        .role-card.selected {
            border-color: var(--theme-color);
            background: rgba(0, 151, 156, 0.05);
            box-shadow: 0 0 0 3px rgba(0, 151, 156, 0.2);
        }

        .role-card.selected .role-icon {
            transform: scale(1.1);
        }

        .step-indicator .step {
            transition: all 0.3s ease;
        }

        .step-indicator .step.active {
            background: var(--theme-color);
            color: white;
        }

        .step-indicator .step.completed {
            background: #10b981;
            color: white;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div class="profile-bg flex flex-col min-h-screen">
        <!-- Header -->
        <header class="py-4 px-6">
            <div class="max-w-2xl mx-auto flex items-center justify-between">
                <div class="flex items-center cursor-pointer" onclick="window.location.href='index.html'">
                    <img src="img/logo.svg" alt="Yeti LAB" class="w-10 h-10 mr-2">
                    <div class="brand-logo">
                        <h1 class="text-xl text-gray-800 leading-tight flex items-baseline gap-1">
                            <span>Yeti</span><span class="brand-lab text-theme">LAB</span>
                        </h1>
                    </div>
                </div>
                <div id="userInfo" class="flex items-center gap-2 text-sm text-gray-600">
                    <span id="userAvatar" class="text-2xl">üë§</span>
                    <span id="userName">Y√ºkleniyor...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex items-center justify-center px-4 py-8">
            <div class="w-full max-w-2xl">
                <!-- Progress Steps -->
                <div class="step-indicator flex justify-center gap-4 mb-8">
                    <div class="step active w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold"
                        data-step="1">1</div>
                    <div class="w-16 h-1 bg-gray-200 self-center rounded"></div>
                    <div class="step w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold"
                        data-step="2">2</div>
                    <div class="w-16 h-1 bg-gray-200 self-center rounded"></div>
                    <div class="step w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold"
                        data-step="3">3</div>
                </div>

                <!-- Step 1: Role Selection -->
                <div id="step1" class="step-content bg-white rounded-2xl p-8 shadow-xl">
                    <h2 class="text-2xl font-bold text-center mb-2">Ho≈ü Geldin! üéâ</h2>
                    <p class="text-gray-600 text-center mb-8">Platformu nasƒ±l kullanacaksƒ±n?</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Teacher Card -->
                        <div class="role-card border-2 border-gray-200 rounded-xl p-6 text-center"
                            onclick="selectRole('teacher')">
                            <div class="role-icon text-6xl mb-4">üë®‚Äçüè´</div>
                            <h3 class="text-xl font-bold mb-2">√ñƒüretmenim</h3>
                            <p class="text-gray-500 text-sm">
                                Sƒ±nƒ±f olu≈ütur, √∂ƒürencileri takip et, i√ßerik y√∂net
                            </p>
                        </div>

                        <!-- Student Card -->
                        <div class="role-card border-2 border-gray-200 rounded-xl p-6 text-center"
                            onclick="selectRole('student')">
                            <div class="role-icon text-6xl mb-4">üéì</div>
                            <h3 class="text-xl font-bold mb-2">√ñƒürenciyim</h3>
                            <p class="text-gray-500 text-sm">
                                Dersleri takip et, projeler yap, ilerleme kaydet
                            </p>
                        </div>
                    </div>

                    <div id="roleError" class="hidden mt-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm text-center">
                        L√ºtfen bir rol se√ßin
                    </div>

                    <button onclick="goToStep(2)"
                        class="mt-8 w-full bg-theme text-white py-4 rounded-xl font-bold text-lg hover:brightness-110 transition-all">
                        Devam Et ‚Üí
                    </button>
                </div>

                <!-- Step 2: School Info -->
                <div id="step2" class="step-content hidden bg-white rounded-2xl p-8 shadow-xl">
                    <h2 class="text-2xl font-bold text-center mb-2">Okul Bilgilerin üè´</h2>
                    <p class="text-gray-600 text-center mb-8">Bu bilgiler sadece istatistik ama√ßlƒ±dƒ±r</p>

                    <div class="space-y-6">
                        <!-- City -->
                        <div>
                            <label class="block text-gray-700 font-bold mb-2">ƒ∞l</label>
                            <select id="citySelect"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-lg"
                                onchange="loadDistricts()">
                                <option value="">ƒ∞l se√ßin...</option>
                            </select>
                        </div>

                        <!-- District -->
                        <div>
                            <label class="block text-gray-700 font-bold mb-2">ƒ∞l√ße</label>
                            <select id="districtSelect"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-lg">
                                <option value="">√ñnce il se√ßin...</option>
                            </select>
                        </div>

                        <!-- School Name -->
                        <div>
                            <label class="block text-gray-700 font-bold mb-2">Okul Adƒ±</label>
                            <input type="text" id="schoolName"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-lg"
                                placeholder="√ñrn: Atat√ºrk ƒ∞lkokulu">
                        </div>
                    </div>

                    <div class="flex gap-4 mt-8">
                        <button onclick="goToStep(1)"
                            class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-xl font-bold text-lg hover:bg-gray-200 transition-all">
                            ‚Üê Geri
                        </button>
                        <button onclick="goToStep(3)"
                            class="flex-1 bg-theme text-white py-4 rounded-xl font-bold text-lg hover:brightness-110 transition-all">
                            Devam Et ‚Üí
                        </button>
                    </div>

                    <p class="text-center text-gray-400 text-sm mt-4">
                        Bu adƒ±mƒ± <a href="#" onclick="skipSchoolInfo()" class="text-theme hover:underline">atla</a>
                    </p>
                </div>

                <!-- Step 3: Confirmation -->
                <div id="step3" class="step-content hidden bg-white rounded-2xl p-8 shadow-xl">
                    <div class="text-center">
                        <div class="text-6xl mb-4">‚ú®</div>
                        <h2 class="text-2xl font-bold mb-2">Harika!</h2>
                        <p class="text-gray-600 mb-8">Profilin hazƒ±r, hadi ba≈ülayalƒ±m!</p>

                        <div id="profileSummary" class="bg-gray-50 rounded-xl p-6 text-left mb-8">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <span class="text-gray-500 text-sm">Rol</span>
                                    <p id="summaryRole" class="font-bold">-</p>
                                </div>
                                <div>
                                    <span class="text-gray-500 text-sm">ƒ∞sim</span>
                                    <p id="summaryName" class="font-bold">-</p>
                                </div>
                                <div>
                                    <span class="text-gray-500 text-sm">≈ûehir</span>
                                    <p id="summaryCity" class="font-bold">-</p>
                                </div>
                                <div>
                                    <span class="text-gray-500 text-sm">Okul</span>
                                    <p id="summarySchool" class="font-bold">-</p>
                                </div>
                            </div>
                        </div>

                        <div id="saveError" class="hidden mb-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm"></div>

                        <button onclick="saveProfile()" id="saveBtn"
                            class="w-full bg-theme text-white py-4 rounded-xl font-bold text-lg hover:brightness-110 transition-all flex items-center justify-center gap-2">
                            <span>Profili Kaydet ve Ba≈üla</span>
                            <span>üöÄ</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="modules/supabaseClient.js"></script>
    <script src="modules/auth.js"></script>
    <script>
        // State
        let selectedRole = null;
        let currentStep = 1;
        let userData = null;
        let isStudentMode = false;
        let studentSessionData = null;

        // Turkey Cities & Districts (simplified)
        const turkeyData = {
            "ƒ∞stanbul": ["Kadƒ±k√∂y", "Be≈üikta≈ü", "√úsk√ºdar", "Fatih", "Bakƒ±rk√∂y", "≈ûi≈üli", "Beyoƒülu", "Maltepe", "Ata≈üehir", "Pendik", "Kartal", "Tuzla", "Sultanbeyli", "√áekmek√∂y", "Sancaktepe", "√úmraniye", "Beykoz", "Sarƒ±yer", "Ey√ºpsultan", "Kaƒüƒ±thane", "Gaziosmanpa≈üa", "Bayrampa≈üa", "Zeytinburnu", "G√ºng√∂ren", "Esenler", "Baƒücƒ±lar", "K√º√ß√ºk√ßekmece", "Bah√ßelievler", "Avcƒ±lar", "Esenyurt", "Ba≈üak≈üehir", "Sultangazi", "Arnavutk√∂y", "B√ºy√ºk√ßekmece", "√áatalca", "Silivri", "≈ûile", "Adalar"],
            "Ankara": ["√áankaya", "Ke√ßi√∂ren", "Mamak", "Etimesgut", "Sincan", "Yenimahalle", "Altƒ±ndaƒü", "Pursaklar", "G√∂lba≈üƒ±", "Polatlƒ±", "Beypazarƒ±", "√áubuk", "Kahramankazan", "Akyurt", "Elmadaƒü", "Aya≈ü", "Haymana", "Kƒ±zƒ±lcahamam", "Nallƒ±han", "≈ûerefliko√ßhisar", "Bala", "Evren", "G√ºd√ºl", "Kalecik"],
            "ƒ∞zmir": ["Konak", "Kar≈üƒ±yaka", "Bornova", "Buca", "Bayraklƒ±", "√áiƒüli", "Gaziemir", "Karabaƒülar", "Narlƒ±dere", "Bal√ßova", "G√ºzelbah√ße", "Urla", "√áe≈üme", "Seferihisar", "Menderes", "Torbalƒ±", "Kemalpa≈üa", "√ñdemi≈ü", "Tire", "Bergama", "Aliaƒüa", "Menemen", "Fo√ßa", "Dikili", "Kiraz", "Beydaƒü", "Sel√ßuk", "Bayƒ±ndƒ±r", "Karaburun", "Kƒ±nƒ±k"],
            "Bursa": ["Osmangazi", "Nil√ºfer", "Yƒ±ldƒ±rƒ±m", "ƒ∞neg√∂l", "Gemlik", "Mudanya", "Mustafakemalpa≈üa", "Karacabey", "Orhangazi", "ƒ∞znik", "Kestel", "G√ºrsu", "Yeni≈üehir", "Keles", "Orhaneli", "Harmancƒ±k", "B√ºy√ºkorhan"],
            "Antalya": ["Muratpa≈üa", "Konyaaltƒ±", "Kepez", "Aksu", "D√∂≈üemealtƒ±", "Alanya", "Manavgat", "Serik", "Ka≈ü", "Kemer", "Kumluca", "Finike", "Gazipa≈üa", "Demre", "Elmalƒ±", "Korkuteli", "Akseki", "ƒ∞bradƒ±", "G√ºndoƒümu≈ü"],
            "Adana": ["√áukurova", "Seyhan", "Y√ºreƒüir", "Sarƒ±√ßam", "Ceyhan", "Kozan", "ƒ∞mamoƒülu", "Karaisalƒ±", "Karata≈ü", "Pozantƒ±", "Aladaƒü", "Feke", "Saimbeyli", "Tufanbeyli", "Yumurtalƒ±k"],
            "Konya": ["Sel√ßuklu", "Meram", "Karatay", "Ereƒüli", "Ak≈üehir", "Bey≈üehir", "Seydi≈üehir", "√áumra", "Ilgƒ±n", "Kulu", "Cihanbeyli", "Karapƒ±nar", "Bozkƒ±r", "Hadim", "Ta≈ükent", "Altƒ±nekin", "Saray√∂n√º", "H√ºy√ºk", "Doƒüanhisar", "G√ºneysƒ±nƒ±r", "Ahƒ±rlƒ±", "Tuzluk√ßu", "Ak√∂ren", "Derbent", "Emirgazi", "Halkapƒ±nar", "Yalƒ±h√ºy√ºk", "Derebucak", "√áeltik"],
            "Gaziantep": ["≈ûahinbey", "≈ûehitkamil", "Oƒüuzeli", "Nizip", "ƒ∞slahiye", "Nurdaƒüƒ±", "Araban", "Yavuzeli", "Karkamƒ±≈ü"],
            "Mersin": ["Yeni≈üehir", "Mezitli", "Akdeniz", "Toroslar", "Tarsus", "Erdemli", "Silifke", "Anamur", "Mut", "Aydƒ±ncƒ±k", "Bozyazƒ±", "√áamlƒ±yayla", "G√ºlnar"],
            "Diyarbakƒ±r": ["Baƒülar", "Kayapƒ±nar", "Sur", "Yeni≈üehir", "Bismil", "Ergani", "Silvan", "√áƒ±nar", "Dicle", "Eƒüil", "Hani", "Hazro", "Kocak√∂y", "Kulp", "Lice", "√áermik", "√á√ºng√º≈ü"],
            "Diƒüer": ["Diƒüer"]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            SupabaseClient.init();

            // 1. Check Teacher Auth
            const teacherSession = await Auth.checkSession();

            // 2. Check Student Auth
            const studentLocal = localStorage.getItem('yeti_student_session');

            if (!teacherSession && !studentLocal) {
                window.location.href = 'auth.html';
                return;
            }

            if (studentLocal && !teacherSession) {
                // Student Mode
                isStudentMode = true;
                studentSessionData = JSON.parse(studentLocal);
                renderStudentProfile();
            } else {
                // Teacher Mode (Existing Logic)
                userData = teacherSession.user;
                setupTeacherProfile();
            }
        });

        // --- STUDENT FUNCTIONS ---

        function renderStudentProfile() {
            // Hide header user info or update it
            document.getElementById('userName').textContent = studentSessionData.displayName;
            document.getElementById('userAvatar').textContent = 'üéì';

            // Replace main content with Student View
            const container = document.querySelector('.w-full.max-w-2xl');
            container.innerHTML = `
                <div class="bg-white rounded-2xl p-8 shadow-xl animate-fade-in-up">
                    <div class="text-center mb-8 pb-8 border-b border-gray-100">
                        <div class="text-6xl mb-4 bg-gray-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto border-4 border-theme shadow-lg transform hover:scale-105 transition-transform duration-300">
                             ${'üéì'}
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-1">${studentSessionData.displayName}</h2>
                        <div class="inline-block px-3 py-1 bg-gray-100 rounded-full text-sm text-gray-500 font-medium">
                            ${studentSessionData.classroomName || '√ñƒürenci'}
                        </div>
                    </div>

                    <!-- ƒ∞lerleme B√∂l√ºm√º -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 mb-8 border border-blue-100">
                        <h3 class="font-bold text-blue-900 mb-4 flex items-center gap-2 text-lg">
                            <span>üèÜ</span> ƒ∞lerleme Durumu
                        </h3>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <p class="text-3xl font-bold text-theme mb-1" id="completedLessons">-</p>
                                <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Tamamlanan Ders</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                <p class="text-3xl font-bold text-orange-500 mb-1" id="totalPoints">-</p>
                                <p class="text-xs text-gray-500 font-medium uppercase tracking-wider">Toplam Puan</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- D√ºzenleme Formu -->
                    <form onsubmit="saveStudentProfile(event)" class="space-y-5">
                        <h3 class="font-bold text-gray-800 text-lg">Profili D√ºzenle</h3>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2 text-sm">G√∂r√ºnen ƒ∞sim</label>
                            <input type="text" id="studentName" value="${studentSessionData.displayName}" required minlength="2"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-4 focus:ring-theme/10 transition-all outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 font-medium mb-2 text-sm">Yeni ≈ûifre <span class="text-gray-400 font-normal">(ƒ∞steƒüe baƒülƒ±)</span></label>
                            <input type="text" id="studentPassword" placeholder="Deƒüi≈ütirmek istemiyorsan bo≈ü bƒ±rak" minlength="3"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-4 focus:ring-theme/10 transition-all outline-none">
                        </div>
                        
                        <div id="studentSaveError" class="hidden text-red-500 text-sm bg-red-50 p-3 rounded-lg border border-red-100"></div>

                        <button type="submit" id="studentSaveBtn"
                            class="w-full bg-theme text-white py-4 rounded-xl font-bold text-lg hover:brightness-110 transition-all shadow-lg shadow-theme/30 active:scale-95">
                            Deƒüi≈üiklikleri Kaydet
                        </button>
                    </form>
                    
                    <button onclick="window.location.href='index.html'" 
                        class="mt-6 w-full bg-white border-2 border-gray-200 text-gray-600 py-3 rounded-xl font-semibold hover:bg-gray-50 hover:border-gray-300 transition-all">
                        Ana Sayfaya D√∂n
                    </button>
                </div>
            `;

            loadStudentStats();
        }

        async function loadStudentStats() {
            try {
                // Get completed lessons count from student_progress table
                const { count, error } = await SupabaseClient.getClient()
                    .from('student_progress')
                    .select('*', { count: 'exact', head: true })
                    .eq('student_id', studentSessionData.studentId)
                    .eq('is_completed', true);

                if (!error) {
                    document.getElementById('completedLessons').textContent = count || 0;
                    document.getElementById('totalPoints').textContent = (count || 0) * 10; // Simple logic: 10 points per lesson
                }
            } catch (e) {
                console.error('Stats load error:', e);
            }
        }

        async function saveStudentProfile(event) {
            event.preventDefault();
            const name = document.getElementById('studentName').value.trim();
            const password = document.getElementById('studentPassword').value.trim();
            const btn = document.getElementById('studentSaveBtn');
            const errorDiv = document.getElementById('studentSaveError');

            if (name.length < 2) {
                errorDiv.textContent = 'ƒ∞sim en az 2 karakter olmalƒ±';
                errorDiv.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'Kaydediliyor...';
            errorDiv.classList.add('hidden');

            try {
                const updates = { display_name: name };
                if (password) updates.password = password;

                const { error } = await SupabaseClient.getClient()
                    .from('students')
                    .update(updates)
                    .eq('id', studentSessionData.studentId);

                if (error) throw error;

                // Update Local Session
                studentSessionData.displayName = name;
                localStorage.setItem('yeti_student_session', JSON.stringify(studentSessionData));

                btn.innerHTML = '‚úÖ Kaydedildi!';
                btn.classList.replace('bg-theme', 'bg-green-500');
                setTimeout(() => {
                    btn.disabled = false;
                    btn.classList.replace('bg-green-500', 'bg-theme');
                    btn.innerHTML = 'Deƒüi≈üiklikleri Kaydet';
                }, 2000);

            } catch (e) {
                console.error(e);
                errorDiv.textContent = 'Hata: ' + e.message;
                errorDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = 'Deƒüi≈üiklikleri Kaydet';
            }
        }


        // --- TEACHER FUNCTIONS (Existing Logic) ---

        function setupTeacherProfile() {
            document.getElementById('userName').textContent =
                userData.user_metadata?.full_name ||
                userData.user_metadata?.name ||
                userData.email?.split('@')[0] || 'Kullanƒ±cƒ±';

            if (userData.user_metadata?.avatar_url) {
                document.getElementById('userAvatar').innerHTML =
                    `<img src="${userData.user_metadata.avatar_url}" class="w-8 h-8 rounded-full" alt="">`;
            }

            loadCities();
        }

        async function checkProfileStatus() {
            // ... existing function ...
            try {
                const { data, error } = await SupabaseClient.getClient()
                    .rpc('check_profile_status');
                return data;
            } catch (e) { return null; }
        }

        function loadCities() {
            const select = document.getElementById('citySelect');
            Object.keys(turkeyData).forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
        }

        function loadDistricts() {
            // ... existing logic ...
            const city = document.getElementById('citySelect').value;
            const districtSelect = document.getElementById('districtSelect');
            districtSelect.innerHTML = '<option value="">ƒ∞l√ße se√ßin...</option>';

            if (city && turkeyData[city]) {
                turkeyData[city].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }

        function selectRole(role) {
            // ... existing logic ...
            selectedRole = role;
            document.querySelectorAll('.role-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('roleError').classList.add('hidden');
        }

        function goToStep(step) {
            // ... existing logic ...
            if (currentStep === 1 && step > 1) {
                if (!selectedRole) {
                    document.getElementById('roleError').classList.remove('hidden');
                    return;
                }
            }
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');
            document.querySelectorAll('.step-indicator .step').forEach((el, idx) => {
                const stepNum = idx + 1;
                el.classList.remove('active', 'completed');
                if (stepNum < step) el.classList.add('completed');
                if (stepNum === step) el.classList.add('active');
            });
            currentStep = step;
            if (step === 3) updateSummary();
        }

        function skipSchoolInfo() { goToStep(3); }

        function updateSummary() {
            document.getElementById('summaryRole').textContent = selectedRole === 'teacher' ? 'üë®‚Äçüè´ √ñƒüretmen' : 'üéì √ñƒürenci';
            document.getElementById('summaryName').textContent = userData?.user_metadata?.full_name || userData?.user_metadata?.name || '-';
            document.getElementById('summaryCity').textContent = document.getElementById('citySelect').value || '-';
            document.getElementById('summarySchool').textContent = document.getElementById('schoolName').value || '-';
        }

        async function saveProfile() {
            // ... existing teacher save logic ...
            const btn = document.getElementById('saveBtn');
            const errorDiv = document.getElementById('saveError');

            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Kaydediliyor...';

            try {
                const { data, error } = await SupabaseClient.getClient()
                    .rpc('update_user_profile', {
                        p_role: selectedRole,
                        p_full_name: userData?.user_metadata?.full_name || userData?.user_metadata?.name || null,
                        p_city: document.getElementById('citySelect').value || null,
                        p_district: document.getElementById('districtSelect').value || null,
                        p_school_name: document.getElementById('schoolName').value || null
                    });

                if (error) throw error;
                if (selectedRole === 'teacher') window.location.href = 'teacher.html';
                else window.location.href = 'index.html';

            } catch (err) {
                console.error('Profile save error:', err);
                errorDiv.textContent = 'Profil kaydedilemedi: ' + err.message;
                errorDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = '<span>Profili Kaydet ve Ba≈üla</span><span>üöÄ</span>';
            }
        }
    </script>
</body>

</html>