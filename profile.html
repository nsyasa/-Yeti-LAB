<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Tamamla - Yeti LAB</title>
    <meta name="description" content="Yeti LAB profilinizi tamamlayƒ±n">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="img/favicon.svg">
    <link rel="apple-touch-icon" href="img/favicon.svg">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Main Styles -->
    <link rel="stylesheet" href="styles/main.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        .profile-bg {
            background: linear-gradient(135deg, #f0fdfa 0%, #ecfdf5 50%, #f0f9ff 100%);
            min-height: 100vh;
        }

        body.dark-mode .profile-bg {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .role-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .role-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.2);
        }

        .role-card.selected {
            border-color: var(--theme-color);
            background: rgba(0, 151, 156, 0.05);
            box-shadow: 0 0 0 3px rgba(0, 151, 156, 0.2);
        }

        .role-card.selected .role-icon {
            transform: scale(1.1);
        }

        .step-indicator .step {
            transition: all 0.3s ease;
        }

        .step-indicator .step.active {
            background: var(--theme-color);
            color: white;
        }

        .step-indicator .step.completed {
            background: #10b981;
            color: white;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div class="profile-bg flex flex-col min-h-screen">
        <!-- Header -->
        <header class="py-4 px-6">
            <div class="max-w-2xl mx-auto flex items-center justify-between">
                <div class="flex items-center cursor-pointer" onclick="window.location.href='index.html'">
                    <img src="img/logo.svg" alt="Yeti LAB" class="w-10 h-10 mr-2">
                    <div class="brand-logo">
                        <h1 class="text-xl text-gray-800 leading-tight flex items-baseline gap-1">
                            <span>Yeti</span><span class="brand-lab text-theme">LAB</span>
                        </h1>
                    </div>
                </div>
                <div id="userInfo" class="flex items-center gap-2 text-sm text-gray-600">
                    <span id="userAvatar" class="text-2xl">üë§</span>
                    <span id="userName">Y√ºkleniyor...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex items-center justify-center px-4 py-8">
            <div class="w-full max-w-2xl">
                <!-- Progress Steps -->
                <div class="step-indicator flex justify-center gap-4 mb-8">
                    <div class="step active w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold"
                        data-step="1">1</div>
                    <div class="w-16 h-1 bg-gray-200 self-center rounded"></div>
                    <div class="step w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold"
                        data-step="2">2</div>
                    <div class="w-16 h-1 bg-gray-200 self-center rounded"></div>
                    <div class="step w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold"
                        data-step="3">3</div>
                </div>

                <!-- Step 1: Role Selection -->
                <div id="step1" class="step-content bg-white rounded-2xl p-8 shadow-xl">
                    <h2 class="text-2xl font-bold text-center mb-2">Ho≈ü Geldin! üéâ</h2>
                    <p class="text-gray-600 text-center mb-8">Platformu nasƒ±l kullanacaksƒ±n?</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Teacher Card -->
                        <div class="role-card border-2 border-gray-200 rounded-xl p-6 text-center"
                            onclick="selectRole('teacher')">
                            <div class="role-icon text-6xl mb-4">üë®‚Äçüè´</div>
                            <h3 class="text-xl font-bold mb-2">√ñƒüretmenim</h3>
                            <p class="text-gray-500 text-sm">
                                Sƒ±nƒ±f olu≈ütur, √∂ƒürencileri takip et, i√ßerik y√∂net
                            </p>
                        </div>

                        <!-- Student Card -->
                        <div class="role-card border-2 border-gray-200 rounded-xl p-6 text-center"
                            onclick="selectRole('student')">
                            <div class="role-icon text-6xl mb-4">üéì</div>
                            <h3 class="text-xl font-bold mb-2">√ñƒürenciyim</h3>
                            <p class="text-gray-500 text-sm">
                                Dersleri takip et, projeler yap, ilerleme kaydet
                            </p>
                        </div>
                    </div>

                    <div id="roleError" class="hidden mt-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm text-center">
                        L√ºtfen bir rol se√ßin
                    </div>

                    <button onclick="goToStep(2)"
                        class="mt-8 w-full bg-theme text-white py-4 rounded-xl font-bold text-lg hover:brightness-110 transition-all">
                        Devam Et ‚Üí
                    </button>
                </div>

                <!-- Step 2: School Info -->
                <div id="step2" class="step-content hidden bg-white rounded-2xl p-8 shadow-xl">
                    <h2 class="text-2xl font-bold text-center mb-2">Okul Bilgilerin üè´</h2>
                    <p class="text-gray-600 text-center mb-8">Bu bilgiler sadece istatistik ama√ßlƒ±dƒ±r</p>

                    <div class="space-y-6">
                        <!-- City -->
                        <div>
                            <label class="block text-gray-700 font-bold mb-2">ƒ∞l</label>
                            <select id="citySelect"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-lg"
                                onchange="loadDistricts()">
                                <option value="">ƒ∞l se√ßin...</option>
                            </select>
                        </div>

                        <!-- District -->
                        <div>
                            <label class="block text-gray-700 font-bold mb-2">ƒ∞l√ße</label>
                            <select id="districtSelect"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-lg">
                                <option value="">√ñnce il se√ßin...</option>
                            </select>
                        </div>

                        <!-- School Name -->
                        <div>
                            <label class="block text-gray-700 font-bold mb-2">Okul Adƒ±</label>
                            <input type="text" id="schoolName"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-theme focus:ring-2 focus:ring-theme/20 transition-all text-lg"
                                placeholder="√ñrn: Atat√ºrk ƒ∞lkokulu">
                        </div>
                    </div>

                    <div class="flex gap-4 mt-8">
                        <button onclick="goToStep(1)"
                            class="flex-1 bg-gray-100 text-gray-700 py-4 rounded-xl font-bold text-lg hover:bg-gray-200 transition-all">
                            ‚Üê Geri
                        </button>
                        <button onclick="goToStep(3)"
                            class="flex-1 bg-theme text-white py-4 rounded-xl font-bold text-lg hover:brightness-110 transition-all">
                            Devam Et ‚Üí
                        </button>
                    </div>

                    <p class="text-center text-gray-400 text-sm mt-4">
                        Bu adƒ±mƒ± <a href="#" onclick="skipSchoolInfo()" class="text-theme hover:underline">atla</a>
                    </p>
                </div>

                <!-- Step 3: Confirmation -->
                <div id="step3" class="step-content hidden bg-white rounded-2xl p-8 shadow-xl">
                    <div class="text-center">
                        <div class="text-6xl mb-4">‚ú®</div>
                        <h2 class="text-2xl font-bold mb-2">Harika!</h2>
                        <p class="text-gray-600 mb-8">Profilin hazƒ±r, hadi ba≈ülayalƒ±m!</p>

                        <div id="profileSummary" class="bg-gray-50 rounded-xl p-6 text-left mb-8">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <span class="text-gray-500 text-sm">Rol</span>
                                    <p id="summaryRole" class="font-bold">-</p>
                                </div>
                                <div>
                                    <span class="text-gray-500 text-sm">ƒ∞sim</span>
                                    <p id="summaryName" class="font-bold">-</p>
                                </div>
                                <div>
                                    <span class="text-gray-500 text-sm">≈ûehir</span>
                                    <p id="summaryCity" class="font-bold">-</p>
                                </div>
                                <div>
                                    <span class="text-gray-500 text-sm">Okul</span>
                                    <p id="summarySchool" class="font-bold">-</p>
                                </div>
                            </div>
                        </div>

                        <div id="saveError" class="hidden mb-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm"></div>

                        <button onclick="saveProfile()" id="saveBtn"
                            class="w-full bg-theme text-white py-4 rounded-xl font-bold text-lg hover:brightness-110 transition-all flex items-center justify-center gap-2">
                            <span>Profili Kaydet ve Ba≈üla</span>
                            <span>üöÄ</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="modules/supabaseClient.js"></script>
    <script src="modules/auth.js"></script>
    <script>
        // State
        let selectedRole = null;
        let currentStep = 1;
        let userData = null;

        // Turkey Cities & Districts (simplified)
        const turkeyData = {
            "ƒ∞stanbul": ["Kadƒ±k√∂y", "Be≈üikta≈ü", "√úsk√ºdar", "Fatih", "Bakƒ±rk√∂y", "≈ûi≈üli", "Beyoƒülu", "Maltepe", "Ata≈üehir", "Pendik", "Kartal", "Tuzla", "Sultanbeyli", "√áekmek√∂y", "Sancaktepe", "√úmraniye", "Beykoz", "Sarƒ±yer", "Ey√ºpsultan", "Kaƒüƒ±thane", "Gaziosmanpa≈üa", "Bayrampa≈üa", "Zeytinburnu", "G√ºng√∂ren", "Esenler", "Baƒücƒ±lar", "K√º√ß√ºk√ßekmece", "Bah√ßelievler", "Avcƒ±lar", "Esenyurt", "Ba≈üak≈üehir", "Sultangazi", "Arnavutk√∂y", "B√ºy√ºk√ßekmece", "√áatalca", "Silivri", "≈ûile", "Adalar"],
            "Ankara": ["√áankaya", "Ke√ßi√∂ren", "Mamak", "Etimesgut", "Sincan", "Yenimahalle", "Altƒ±ndaƒü", "Pursaklar", "G√∂lba≈üƒ±", "Polatlƒ±", "Beypazarƒ±", "√áubuk", "Kahramankazan", "Akyurt", "Elmadaƒü", "Aya≈ü", "Haymana", "Kƒ±zƒ±lcahamam", "Nallƒ±han", "≈ûerefliko√ßhisar", "Bala", "Evren", "G√ºd√ºl", "Kalecik"],
            "ƒ∞zmir": ["Konak", "Kar≈üƒ±yaka", "Bornova", "Buca", "Bayraklƒ±", "√áiƒüli", "Gaziemir", "Karabaƒülar", "Narlƒ±dere", "Bal√ßova", "G√ºzelbah√ße", "Urla", "√áe≈üme", "Seferihisar", "Menderes", "Torbalƒ±", "Kemalpa≈üa", "√ñdemi≈ü", "Tire", "Bergama", "Aliaƒüa", "Menemen", "Fo√ßa", "Dikili", "Kiraz", "Beydaƒü", "Sel√ßuk", "Bayƒ±ndƒ±r", "Karaburun", "Kƒ±nƒ±k"],
            "Bursa": ["Osmangazi", "Nil√ºfer", "Yƒ±ldƒ±rƒ±m", "ƒ∞neg√∂l", "Gemlik", "Mudanya", "Mustafakemalpa≈üa", "Karacabey", "Orhangazi", "ƒ∞znik", "Kestel", "G√ºrsu", "Yeni≈üehir", "Keles", "Orhaneli", "Harmancƒ±k", "B√ºy√ºkorhan"],
            "Antalya": ["Muratpa≈üa", "Konyaaltƒ±", "Kepez", "Aksu", "D√∂≈üemealtƒ±", "Alanya", "Manavgat", "Serik", "Ka≈ü", "Kemer", "Kumluca", "Finike", "Gazipa≈üa", "Demre", "Elmalƒ±", "Korkuteli", "Akseki", "ƒ∞bradƒ±", "G√ºndoƒümu≈ü"],
            "Adana": ["√áukurova", "Seyhan", "Y√ºreƒüir", "Sarƒ±√ßam", "Ceyhan", "Kozan", "ƒ∞mamoƒülu", "Karaisalƒ±", "Karata≈ü", "Pozantƒ±", "Aladaƒü", "Feke", "Saimbeyli", "Tufanbeyli", "Yumurtalƒ±k"],
            "Konya": ["Sel√ßuklu", "Meram", "Karatay", "Ereƒüli", "Ak≈üehir", "Bey≈üehir", "Seydi≈üehir", "√áumra", "Ilgƒ±n", "Kulu", "Cihanbeyli", "Karapƒ±nar", "Bozkƒ±r", "Hadim", "Ta≈ükent", "Altƒ±nekin", "Saray√∂n√º", "H√ºy√ºk", "Doƒüanhisar", "G√ºneysƒ±nƒ±r", "Ahƒ±rlƒ±", "Tuzluk√ßu", "Ak√∂ren", "Derbent", "Emirgazi", "Halkapƒ±nar", "Yalƒ±h√ºy√ºk", "Derebucak", "√áeltik"],
            "Gaziantep": ["≈ûahinbey", "≈ûehitkamil", "Oƒüuzeli", "Nizip", "ƒ∞slahiye", "Nurdaƒüƒ±", "Araban", "Yavuzeli", "Karkamƒ±≈ü"],
            "Mersin": ["Yeni≈üehir", "Mezitli", "Akdeniz", "Toroslar", "Tarsus", "Erdemli", "Silifke", "Anamur", "Mut", "Aydƒ±ncƒ±k", "Bozyazƒ±", "√áamlƒ±yayla", "G√ºlnar"],
            "Diyarbakƒ±r": ["Baƒülar", "Kayapƒ±nar", "Sur", "Yeni≈üehir", "Bismil", "Ergani", "Silvan", "√áƒ±nar", "Dicle", "Eƒüil", "Hani", "Hazro", "Kocak√∂y", "Kulp", "Lice", "√áermik", "√á√ºng√º≈ü"],
            "Diƒüer": ["Diƒüer"]
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            SupabaseClient.init();

            // Check auth
            const session = await Auth.checkSession();
            if (!session) {
                window.location.href = 'auth.html';
                return;
            }

            // Check if profile already complete
            const profileStatus = await checkProfileStatus();
            if (profileStatus && profileStatus.is_profile_complete) {
                window.location.href = 'index.html';
                return;
            }

            // Set user info
            userData = session.user;
            document.getElementById('userName').textContent =
                userData.user_metadata?.full_name ||
                userData.user_metadata?.name ||
                userData.email?.split('@')[0] || 'Kullanƒ±cƒ±';

            if (userData.user_metadata?.avatar_url) {
                document.getElementById('userAvatar').innerHTML =
                    `<img src="${userData.user_metadata.avatar_url}" class="w-8 h-8 rounded-full" alt="">`;
            }

            // Load cities
            loadCities();
        });

        async function checkProfileStatus() {
            try {
                const { data, error } = await SupabaseClient.getClient()
                    .rpc('check_profile_status');
                return data;
            } catch (e) {
                console.warn('Profile status check failed:', e);
                return null;
            }
        }

        function loadCities() {
            const select = document.getElementById('citySelect');
            Object.keys(turkeyData).forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
        }

        function loadDistricts() {
            const city = document.getElementById('citySelect').value;
            const districtSelect = document.getElementById('districtSelect');
            districtSelect.innerHTML = '<option value="">ƒ∞l√ße se√ßin...</option>';

            if (city && turkeyData[city]) {
                turkeyData[city].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }

        function selectRole(role) {
            selectedRole = role;
            document.querySelectorAll('.role-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('roleError').classList.add('hidden');
        }

        function goToStep(step) {
            // Validation for step 1
            if (currentStep === 1 && step > 1) {
                if (!selectedRole) {
                    document.getElementById('roleError').classList.remove('hidden');
                    return;
                }
            }

            // Update UI
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step${step}`).classList.remove('hidden');

            // Update step indicators
            document.querySelectorAll('.step-indicator .step').forEach((el, idx) => {
                const stepNum = idx + 1;
                el.classList.remove('active', 'completed');
                if (stepNum < step) el.classList.add('completed');
                if (stepNum === step) el.classList.add('active');
            });

            currentStep = step;

            // Prepare summary for step 3
            if (step === 3) {
                updateSummary();
            }
        }

        function skipSchoolInfo() {
            goToStep(3);
        }

        function updateSummary() {
            document.getElementById('summaryRole').textContent = selectedRole === 'teacher' ? 'üë®‚Äçüè´ √ñƒüretmen' : 'üéì √ñƒürenci';
            document.getElementById('summaryName').textContent = userData?.user_metadata?.full_name || userData?.user_metadata?.name || '-';
            document.getElementById('summaryCity').textContent = document.getElementById('citySelect').value || '-';
            document.getElementById('summarySchool').textContent = document.getElementById('schoolName').value || '-';
        }

        async function saveProfile() {
            const btn = document.getElementById('saveBtn');
            const errorDiv = document.getElementById('saveError');

            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Kaydediliyor...';

            try {
                const { data, error } = await SupabaseClient.getClient()
                    .rpc('update_user_profile', {
                        p_role: selectedRole,
                        p_full_name: userData?.user_metadata?.full_name || userData?.user_metadata?.name || null,
                        p_city: document.getElementById('citySelect').value || null,
                        p_district: document.getElementById('districtSelect').value || null,
                        p_school_name: document.getElementById('schoolName').value || null
                    });

                if (error) throw error;

                // Redirect based on role
                if (selectedRole === 'teacher') {
                    window.location.href = 'teacher.html';
                } else {
                    window.location.href = 'index.html';
                }

            } catch (err) {
                console.error('Profile save error:', err);
                errorDiv.textContent = 'Profil kaydedilemedi: ' + err.message;
                errorDiv.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = '<span>Profili Kaydet ve Ba≈üla</span><span>üöÄ</span>';
            }
        }
    </script>
</body>

</html>