const h={config:{onUpdate:null,getPhases:()=>[],getProjects:()=>[],getCourseId:()=>null,getPhaseIdMap:()=>({}),setPhaseId:(e,t)=>{}},saveTimer:null,currentPhaseIndex:null,init(e){this.config={...this.config,...e},this.bindEvents()},bindEvents(){document.addEventListener("input",e=>{const t=document.getElementById("phase-form");if(!t||!t.contains(e.target))return;const s=e.target.id;(s==="ph-title"||s==="ph-icon"||s==="ph-desc")&&this.update()}),document.addEventListener("change",e=>{const t=document.getElementById("phase-form");!t||!t.contains(e.target)||e.target.id==="ph-color"&&this.update()})},renderList(){const e=document.getElementById("phase-list");if(!e)return;e.innerHTML="";const t=this.config.getPhases();if(t)try{t.forEach((s,n)=>{if(window.PhasesSection&&PhasesSection.renderPhaseCard){const i={id:n,name:s?.title||`BÃ¶lÃ¼m ${n}`,title:s?.title||`BÃ¶lÃ¼m ${n}`,icon:s?.icon||"ğŸ“",color:s?.color||"gray",projectCount:0};e.innerHTML+=PhasesSection.renderPhaseCard(i,n,t.length)}else{const i=n===this.currentPhaseIndex?"bg-amber-50 border-amber-500":"hover:bg-gray-50 border-transparent",a=s?.icon||"ğŸ“",c=s?.title||`BÃ¶lÃ¼m ${n}`,o=s?.description||"";e.innerHTML+=`
                        <div onclick="PhaseManager.load(${n})" class="p-3 border-l-4 cursor-pointer transition ${i}">
                            <div class="flex items-center">
                                <span class="w-3 h-3 rounded-full bg-${s?.color||"gray"}-500 mr-3"></span>
                                <div>
                                    <div class="font-bold text-sm text-gray-700">${a} ${c}</div>
                                    <div class="text-xs text-gray-400">${o}</div>
                                </div>
                            </div>
                        </div>`}})}catch(s){console.error("Error rendering phase list:",s),e.innerHTML+='<div class="p-2 text-red-500 text-xs">Hata: Fazlar yÃ¼klenirken sorun oluÅŸtu.</div>'}},load(e){this.currentPhaseIndex=e;const t=this.config.getPhases();if(!t||!t[e])return;const s=t[e],n=document.getElementById("phase-welcome"),i=document.getElementById("phase-form");n&&n.classList.add("hidden"),i&&i.classList.remove("hidden");const a=document.getElementById("ph-title"),c=document.getElementById("ph-icon"),o=document.getElementById("ph-desc"),r=document.getElementById("ph-color");a&&(a.value=s.title||`BÃ¶lÃ¼m ${e}`),c&&(c.value=s.icon||"ğŸ“"),o&&(o.value=s.description||""),r&&(r.value=s.color||"gray"),this.renderList()},update(){if(this.currentPhaseIndex===null)return;const e=this.config.getPhases();if(!e||!e[this.currentPhaseIndex])return;const t=e[this.currentPhaseIndex],s=document.getElementById("ph-title"),n=document.getElementById("ph-icon"),i=document.getElementById("ph-desc"),a=document.getElementById("ph-color");s&&(t.title=s.value),n&&(t.icon=n.value),i&&(t.description=i.value),a&&(t.color=a.value),this.renderList(),this.config.onUpdate&&this.config.onUpdate(),this.scheduleSaveToSupabase(this.currentPhaseIndex,t)},scheduleSaveToSupabase(e,t){this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>this.savePhaseToSupabase(e,t),500)},async savePhaseToSupabase(e,t){const s=this.config.getCourseId?.();if(!s){console.warn("[PhaseManager] Cannot save to Supabase: missing courseId");return}if(typeof SupabaseSync<"u"){const n=await SupabaseSync.savePhaseToSupabase(s,t,e);n&&this.config.setPhaseId&&this.config.setPhaseId(e,n.id)}},async add(){const e=this.config.getPhases();if(!e)return;const t=e.length,s={title:`BÃ¶lÃ¼m ${t}`,icon:"âœ¨",description:"Yeni bÃ¶lÃ¼m aÃ§Ä±klamasÄ±",color:"blue"};e.push(s),this.renderList(),this.load(t),this.config.onUpdate&&this.config.onUpdate(),await this.savePhaseToSupabase(t,s)},async delete(){if(this.currentPhaseIndex===null)return null;const e=this.config.getPhases(),t=this.config.getProjects(),s=this.currentPhaseIndex,n=t?t.filter(l=>l.phase===s).length:0;if(n>0){if(!confirm(`Bu fazda ${n} ders var! Silmek, bu derslerin gÃ¶rÃ¼nmez olmasÄ±na neden olur. Devam?`))return null}else if(!confirm("Bu fazÄ± silmek istediÄŸinize emin misiniz?"))return null;const a=this.config.getPhaseIdMap?.()?.[s];if(a&&typeof SupabaseSync<"u"&&!await SupabaseSync.deletePhaseFromSupabase(a))return alert("Supabase silme hatasÄ±. Yerel veri silinmedi."),null;const c=e[s];e.splice(s,1),this.currentPhaseIndex=null;const o=document.getElementById("phase-welcome"),r=document.getElementById("phase-form");return o&&o.classList.remove("hidden"),r&&r.classList.add("hidden"),this.renderList(),this.config.onUpdate&&this.config.onUpdate(),c},getCurrentIndex(){return this.currentPhaseIndex},updateName(e,t){const s=this.config.getPhases();!s||!s[e]||(s[e].title=t,this.config.onUpdate&&this.config.onUpdate(),this.scheduleSaveToSupabase(e,s[e]))},async moveUp(e){const t=this.config.getPhases();!t||e<=0||([t[e-1],t[e]]=[t[e],t[e-1]],this.renderList(),this.config.onUpdate&&this.config.onUpdate(),await Promise.all([this.savePhaseToSupabase(e-1,t[e-1]),this.savePhaseToSupabase(e,t[e])]))},async moveDown(e){const t=this.config.getPhases();!t||e>=t.length-1||([t[e],t[e+1]]=[t[e+1],t[e]],this.renderList(),this.config.onUpdate&&this.config.onUpdate(),await Promise.all([this.savePhaseToSupabase(e,t[e]),this.savePhaseToSupabase(e+1,t[e+1])]))},async deleteByIndex(e){const t=this.config.getPhases(),s=this.config.getProjects();if(!t||e<0||e>=t.length)return null;const n=s?s.filter(o=>o.phase===e).length:0;if(n>0){if(!confirm(`Bu fazda ${n} ders var! Silmek, bu derslerin gÃ¶rÃ¼nmez olmasÄ±na neden olur. Devam?`))return null}else if(!confirm("Bu fazÄ± silmek istediÄŸinize emin misiniz?"))return null;const a=this.config.getPhaseIdMap?.()?.[e];if(a&&typeof SupabaseSync<"u"&&!await SupabaseSync.deletePhaseFromSupabase(a))return alert("Supabase silme hatasÄ±. Yerel veri silinmedi."),null;const c=t[e];return t.splice(e,1),this.currentPhaseIndex=null,this.renderList(),this.config.onUpdate&&this.config.onUpdate(),c},dragStart(e,t){e.dataTransfer.setData("text/plain",t.toString()),e.dataTransfer.effectAllowed="move"},allowDrop(e){e.preventDefault(),e.dataTransfer.dropEffect="move"},async drop(e,t){e.preventDefault();const s=parseInt(e.dataTransfer.getData("text/plain"),10);if(isNaN(s)||s===t)return;const n=this.config.getPhases();if(!n)return;const[i]=n.splice(s,1);n.splice(t,0,i),this.renderList(),this.config.onUpdate&&this.config.onUpdate();const a=[],c=Math.min(s,t),o=Math.max(s,t);for(let r=c;r<=o;r++)a.push(r);await Promise.all(a.map(r=>this.savePhaseToSupabase(r,n[r])))}};window.PhaseManager=h;
