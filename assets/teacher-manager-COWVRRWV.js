let c=null,r=[],y=[],m=null,g=[],A="üéì",v="üéì",B=null;async function ie(){try{if(typeof SupabaseClient<"u"&&await SupabaseClient.init(),typeof Auth<"u"){if(await Auth.init(),Auth.currentUser){if(Auth.userRole!=="teacher"&&Auth.userRole!=="admin"){s("Bu sayfa sadece √∂ƒüretmenler i√ßindir","error"),setTimeout(()=>{Router.redirectTo("index.html")},2e3);return}c=Auth.currentUser,I(),M(),await w(),await N(),C()}else if(!window.location.pathname.includes("auth.html")){console.warn("No user, redirecting to auth..."),Router.redirectTo("auth.html");return}}}catch(t){console.error("Initialization error:",t),s("Ba≈ülatma hatasƒ±: "+t.message,"error")}}function _(t){if(window.TeacherView?.showSection){TeacherView.showSection(t,!1);return}const e=t.charAt(0).toUpperCase()+t.slice(1);document.querySelectorAll('[id^="teacher"][id$="Section"]').forEach(a=>a.classList.add("hidden"));const n=document.getElementById(`teacher${e}Section`);n&&n.classList.remove("hidden"),typeof TeacherLayout<"u"&&TeacherLayout.updateActiveTab&&TeacherLayout.updateActiveTab(t),t==="classrooms"&&H(),t==="students"&&j()}function C(){const t=document.getElementById("loadingState");t&&t.classList.add("hidden")}function I(){if(typeof Auth>"u")return;const t=Auth.getDisplayName(),e=Auth.getAvatarUrl(),n=document.getElementById("user-name");n&&(n.textContent=t);const a=document.getElementById("user-avatar");a&&(e&&(e.startsWith("http")||e.startsWith("data:"))?(a.innerHTML=`<img src="${e}" alt="Avatar" class="w-full h-full object-cover">`,a.classList.add("overflow-hidden"),a.classList.remove("flex","items-center","justify-center")):(a.textContent=e||t.charAt(0).toUpperCase(),a.classList.remove("overflow-hidden"),a.classList.add("flex","items-center","justify-center")))}function D(){document.getElementById("sidebar").classList.toggle("open"),document.getElementById("sidebarOverlay").classList.toggle("open")}function P(){window.ThemeManager&&window.ThemeManager.toggle()}function M(){window.ThemeManager&&window.ThemeManager.load()}function s(t,e="info"){if(window.Toast)e==="success"?window.Toast.success(t):e==="error"?window.Toast.error(t):e==="warning"?window.Toast.warning(t):window.Toast.info(t);else{const n=document.getElementById("toast");if(n){const a=document.getElementById("toastMessage");a.textContent=t,n.className="fixed bottom-6 right-6 px-6 py-4 rounded-xl shadow-2xl transform transition-all duration-300 z-50",e==="success"?n.classList.add("bg-green-600","text-white"):e==="error"?n.classList.add("bg-red-600","text-white"):n.classList.add("bg-gray-900","text-white"),n.classList.remove("translate-y-20","opacity-0"),setTimeout(()=>{n.classList.add("translate-y-20","opacity-0")},3e3)}else alert(t)}}function E(t){if(!t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}function $(t){if(!t)return"Hi√ß";const e=new Date(t),a=new Date-e,o=Math.floor(a/6e4),d=Math.floor(a/36e5),i=Math.floor(a/864e5);return o<1?"Az √∂nce":o<60?`${o} dk √∂nce`:d<24?`${d} saat √∂nce`:i<7?`${i} g√ºn √∂nce`:Utils.formatDate(t)}async function N(){return typeof TeacherAnalytics<"u"?await TeacherAnalytics.loadProjects():{}}async function w(){try{if(!c&&typeof Auth<"u"&&Auth.currentUser&&(c=Auth.currentUser),!c){console.warn("[TeacherManager] No user found for dashboard data");return}console.log("[TeacherManager] loadDashboardData - Starting with user:",{id:c.id,email:c.email}),console.log("[TeacherManager] Querying classrooms with teacher_id:",c.id);const{data:t,error:e}=await SupabaseClient.getClient().from("classrooms").select("*, students(count)").eq("teacher_id",c.id);if(console.log("[TeacherManager] Classrooms query result:",{success:!e,count:t?.length||0,error:e,data:t}),e)throw console.error("[TeacherManager] ‚ùå Classrooms query ERROR:",e),e;r=t||[];const n=r.length;let a=0,o=0;if(r.length>0){const L=r.map(h=>h.id),{data:p,error:de}=await SupabaseClient.getClient().from("students").select("*").in("classroom_id",L);if(!de&&p){y=p,a=p.length;const h=new Date;h.setHours(0,0,0,0),o=p.filter(x=>x.last_active_at?new Date(x.last_active_at)>=h:!1).length}}else y=[];const d=document.getElementById("statClassrooms"),i=document.getElementById("statStudents"),l=document.getElementById("statActiveToday"),u=document.getElementById("statCompletedLessons");d&&(d.textContent=n),i&&(i.textContent=a),l&&(l.textContent=o),u&&(u.textContent="0"),typeof TeacherLayout<"u"&&TeacherLayout.updateSidebarStats&&TeacherLayout.updateSidebarStats(n,a),ce(r),typeof ClassroomManager<"u"&&ClassroomManager.init(c,r,{onStateChange:()=>{w()}}),typeof StudentManager<"u"&&StudentManager.init(c,y,r,{onStateChange:()=>{w()}})}catch(t){console.error("Error loading dashboard data:",t),s("Veri y√ºklenirken hata olu≈ütu","error")}}function H(){console.log("[TeacherManager] loadClassrooms called, ClassroomManager available:",!!window.ClassroomManager),window.ClassroomManager?ClassroomManager.renderList():console.warn("[TeacherManager] ClassroomManager not available")}function j(){console.log("[TeacherManager] loadStudents called, StudentManager available:",!!window.StudentManager),window.StudentManager?StudentManager.renderList():console.warn("[TeacherManager] StudentManager not available")}async function re(){typeof TeacherAnalytics<"u"&&TeacherAnalytics.renderCourseProgress("courseProgress",y)}function f(t){const e=document.getElementById(t);e&&(e.classList.remove("open","active"),e.classList.add("hidden"))}async function le(t){t.preventDefault();const e=t.target.querySelector('button[type="submit"]');if(e&&e.disabled)return;const n=document.getElementById("classroomName").value.trim(),a=document.getElementById("classroomDescription").value.trim();if(!n){s("Sƒ±nƒ±f adƒ± gerekli","error");return}if(typeof ClassroomManager<"u"){const o=await ClassroomManager.create(n,a,e);o.success?(f("createClassroomModal"),document.getElementById("createClassroomForm").reset(),s(`"${o.data.name}" sƒ±nƒ±fƒ± olu≈üturuldu! Kod: ${o.data.code}`,"success")):s("Sƒ±nƒ±f olu≈üturulurken hata olu≈ütu","error")}else console.error("ClassroomManager not loaded")}function R(t){if(m=r.find(n=>n.id===t),!m)return;document.getElementById("viewClassroomName").textContent=m.name,document.getElementById("viewClassroomCode").textContent=m.code;const e=document.getElementById("viewClassroomModal");e.classList.remove("hidden"),e.classList.add("open")}async function V(t,e){typeof ClassroomManager<"u"&&((await ClassroomManager.toggle(t,e)).success?s(e?"Sƒ±nƒ±f aktifle≈ütirildi":"Sƒ±nƒ±f duraklatƒ±ldƒ±","success"):s("ƒ∞≈ülem ba≈üarƒ±sƒ±z","error"))}async function z(t){const e=r.find(n=>n.id===t);e&&confirm(`"${e.name}" sƒ±nƒ±fƒ±nƒ± silmek istediƒüinize emin misiniz?

Bu i≈ülem geri alƒ±namaz ve t√ºm √∂ƒürenci verileri silinecektir.`)&&typeof ClassroomManager<"u"&&((await ClassroomManager.delete(t)).success?s("Sƒ±nƒ±f silindi","success"):s("Sƒ±nƒ±f silinirken hata olu≈ütu","error"))}function ce(t){const e=document.getElementById("dashboardClassroomsList");if(e){if(!t||t.length===0){e.innerHTML=`
            <div class="empty-state py-6">
                <div class="icon text-3xl mb-2">üè´</div>
                <p class="text-slate-500 dark:text-slate-400 text-sm">Hen√ºz sƒ±nƒ±f olu≈üturmadƒ±nƒ±z</p>
                <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">Saƒü √ºstteki "Yeni Sƒ±nƒ±f" butonuna tƒ±klayƒ±n</p>
            </div>
        `;return}e.innerHTML=t.map(n=>{const a=n.students?.[0]?.count||0;return`
            <div class="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors cursor-pointer group" onclick="viewClassroom('${n.id}')">
                <div class="flex items-center gap-3">
                    <span class="text-xl">${n.is_active?"‚úÖ":"‚è∏Ô∏è"}</span>
                    <div>
                        <p class="font-semibold text-sm text-slate-800 dark:text-white">${E(n.name)}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">üë®‚Äçüéì ${a} √∂ƒürenci ‚Ä¢ <span class="font-mono">${n.code}</span></p>
                    </div>
                </div>
                <button onclick="event.stopPropagation(); openClassroomSettings('${n.id}')" class="p-1.5 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors opacity-0 group-hover:opacity-100" title="Ayarlar">
                    ‚öôÔ∏è
                </button>
            </div>
        `}).join("")}}function q(t){const e=t.textContent;navigator.clipboard.writeText(e).then(()=>{s(`Kod kopyalandƒ±: ${e}`,"success")}).catch(()=>{s("Kopyalama ba≈üarƒ±sƒ±z","error")})}function U(){if(!m)return;const t=`Yeti LAB'a katƒ±l!

Sƒ±nƒ±f: ${m.name}
Kod: ${m.code}

Giri≈ü: ${window.location.origin}/auth.html`;navigator.share?navigator.share({title:"Yeti LAB Sƒ±nƒ±f Daveti",text:t}):(navigator.clipboard.writeText(t),s("Davet metni kopyalandƒ±","success"))}function b(t){A=t;const e=document.getElementById("selectedAvatar");e&&(e.value=t),document.querySelectorAll(".avatar-btn").forEach(a=>{a.classList.remove("selected","border-theme","bg-theme/10"),a.classList.add("border-gray-200")});const n=document.querySelector(`.avatar-btn[data-emoji="${t}"]`);n&&(n.classList.remove("border-gray-200"),n.classList.add("selected","border-theme","bg-theme/10"))}function G(t){t&&(document.getElementById("newStudentClassroom").value=t),document.getElementById("studentName").value="",typeof b=="function"&&b("üéì");const e=typeof StudentManager<"u"?StudentManager.generatePassword():"123456";document.getElementById("studentPassword").value=e;const n=document.getElementById("addStudentModal");n.classList.remove("hidden"),n.classList.add("open")}async function F(t){t.preventDefault();const e=t.target.querySelector('button[type="submit"]');if(e&&e.disabled)return;const n=document.getElementById("newStudentClassroom").value,a=document.getElementById("studentName").value.trim(),o=document.getElementById("studentPassword").value.trim(),d=A||"üéì";if(!a){s("√ñƒürenci adƒ± gerekli","error");return}const i=e?e.innerHTML:"Ekle";if(e&&(e.disabled=!0,e.innerHTML='<span class="spinner"></span> Ekleniyor...'),typeof StudentManager<"u"){const l=await StudentManager.add(n,a,o,d);l.success?(f("addStudentModal"),document.getElementById("addStudentForm").reset(),s(`${l.data.display_name} eklendi!`,"success")):s("√ñƒürenci eklenemedi","error")}e&&(e.disabled=!1,e.innerHTML=i)}async function K(t){confirm("Bu √∂ƒürenciyi silmek istediƒüinize emin misiniz?")&&typeof StudentManager<"u"&&((await StudentManager.delete(t)).success?s("√ñƒürenci silindi","success"):s("Silme hatasƒ±","error"))}function Y(){typeof StudentManager<"u"&&StudentManager.printList()}function O(){const t=typeof StudentManager<"u"?StudentManager.generatePassword():"123456",e=document.getElementById("studentPassword");e&&document.getElementById("addStudentModal").classList.contains("open")&&(e.value=t);const n=document.getElementById("editStudentPassword");return n&&document.getElementById("editStudentModal").classList.contains("open")&&(n.value=t,document.getElementById("editRemovePassword").checked=!1),t}function W(t=null){const e=document.getElementById("bulkStudentClassroom");e&&r&&(e.innerHTML='<option value="">Sƒ±nƒ±f se√ßin...</option>'+r.map(a=>`<option value="${a.id}" ${a.id===t?"selected":""}>${E(a.name)}</option>`).join(""),t&&(e.value=t)),typeof S=="function"&&S();const n=document.getElementById("bulkAddModal");n.classList.remove("hidden"),n.classList.add("open")}function Q(){const t=document.getElementById("bulkStudentClassroom").value,e=document.getElementById("bulkStudentList").value.trim(),n=document.getElementById("bulkGeneratePassword").checked;if(!t||!e){s("Sƒ±nƒ±f ve liste gerekli","error");return}const a=e.split(`
`).filter(d=>d.trim()!=="");if(a.length===0){s("Ge√ßerli isim bulunamadƒ±","error");return}g=a.map(d=>({name:d.trim(),password:n?Math.floor(1e5+Math.random()*9e5).toString():null,avatar:"üéì"})),document.getElementById("bulkCount").textContent=g.length;const o=document.getElementById("bulkPreviewTable");o.innerHTML=g.map(d=>`
        <tr class="bg-white dark:bg-gray-800">
            <td class="py-2 pr-2 font-medium text-gray-900 dark:text-white">${E(d.name)}</td>
            <td class="py-2 pr-2 font-mono text-gray-600 dark:text-gray-400">${d.password||"-"}</td>
            <td class="py-2 text-2xl">${d.avatar}</td>
        </tr>
    `).join(""),document.getElementById("bulkStep1").classList.add("hidden"),document.getElementById("bulkStep2").classList.remove("hidden")}function S(){document.getElementById("bulkStep1").classList.remove("hidden"),document.getElementById("bulkStep2").classList.add("hidden"),document.getElementById("bulkStudentList").value="",g=[]}function J(){if(g.length===0)return;const t=g.map(e=>e.password?`${e.name}	${e.password}`:e.name).join(`
`);navigator.clipboard.writeText(t).then(()=>s("Liste kopyalandƒ±","success"))}async function X(){const t=document.getElementById("bulkStudentClassroom").value,e=document.getElementById("saveBulkBtn");if(typeof StudentManager<"u"){const n=g.map(d=>({classroom_id:t,display_name:d.name,password:d.password,avatar_emoji:d.avatar,added_by_teacher:!0})),a=e.innerHTML;e.disabled=!0;const o=await StudentManager.bulkAdd(n);e.disabled=!1,e.innerHTML=a,o.success?(f("bulkAddModal"),s(`${o.data.length} √∂ƒürenci eklendi`,"success")):s("Ekleme hatasƒ±","error")}}function k(t){if(typeof StudentManager<"u"){v=t;const e=document.getElementById("editSelectedAvatar");e&&(e.value=t),document.querySelectorAll(".edit-avatar-btn").forEach(a=>{a.classList.remove("selected","border-theme","bg-theme/10"),a.classList.add("border-gray-200")});const n=document.querySelector(`.edit-avatar-btn[data-emoji="${t}"]`);n&&(n.classList.remove("border-gray-200"),n.classList.add("selected","border-theme","bg-theme/10"))}}function T(t){if(typeof StudentManager<"u"){const e=StudentManager.students.find(d=>d.id===t);if(!e)return;document.getElementById("editStudentId").value=t,document.getElementById("editStudentName").value=e.display_name,document.getElementById("editStudentPassword").value="",document.getElementById("editRemovePassword").checked=!1;const n=document.getElementById("editPasswordStatus");e.password?(n.textContent="≈ûifre Var",n.className="text-xs font-normal px-2 py-0.5 rounded-full bg-green-100 text-green-600"):(n.textContent="≈ûifre Yok",n.className="text-xs font-normal px-2 py-0.5 rounded-full bg-gray-100 text-gray-600"),v=e.avatar_emoji||"üéì";const a=document.getElementById("editSelectedAvatar");a&&(a.value=v),k(v);const o=document.getElementById("editStudentModal");o.classList.remove("hidden"),o.classList.add("open")}}async function Z(t){t.preventDefault();const e=document.getElementById("saveStudentEditBtn");if(e.disabled)return;const n=document.getElementById("editStudentId").value,a=document.getElementById("editStudentName").value.trim(),o=document.getElementById("editStudentPassword").value.trim(),d=document.getElementById("editRemovePassword").checked,i=document.getElementById("editSelectedAvatar").value;if(!a){s("ƒ∞sim gerekli","error");return}const l={display_name:a,avatar_emoji:i};d?l.password=null:o&&(l.password=o);const u=e.innerHTML;e.disabled=!0,typeof StudentManager<"u"&&((await StudentManager.update(n,l)).success?(f("editStudentModal"),s("G√ºncellendi","success")):s("G√ºncelleme hatasƒ±","error")),e.disabled=!1,e.innerHTML=u}function ee(t){if(typeof TeacherAnalytics<"u"){const e=t.map(n=>n.project_id);TeacherAnalytics.renderStudentDetailStats(e)}}function te(t){if(typeof TeacherAnalytics<"u"){const e=t.map(n=>n.project_id);TeacherAnalytics.renderStudentProjectList("detailCourseProgress",e),TeacherAnalytics.renderStudentRecentLessons("detailRecentLessons",t)}}function ue(t){te(t)}function ne(){B&&(f("studentDetailModal"),T(B))}async function ae(t){B=t;const e=y.find(a=>a.id===t);if(!e)return;document.getElementById("detailStudentName").textContent=e.display_name,document.getElementById("detailStudentAvatar").textContent=e.avatar||"üéì",document.getElementById("detailCompletedCount").textContent="-",document.getElementById("detailAvgScore").textContent="-",document.getElementById("detailCourseProgress").innerHTML='<div class="spinner"></div>',document.getElementById("detailRecentLessons").innerHTML="";const n=document.getElementById("studentDetailModal");if(n.classList.remove("hidden"),n.classList.add("open"),typeof TeacherAnalytics<"u"){const a=await TeacherAnalytics.loadStudentDetails(t),o=a.length;document.getElementById("detailCompletedCount").textContent=o;let d=0,i=0;a.forEach(u=>{u.quiz_score!==null&&(d+=u.quiz_score,i++)});const l=i>0?Math.round(d/i):0;document.getElementById("detailAvgScore").textContent=l+"%",e.last_active_at?document.getElementById("detailLastActive").textContent=$(e.last_active_at):document.getElementById("detailLastActive").textContent="Hi√ß",ee(a),te(a)}}function se(t){const e=r.find(a=>a.id===t);if(!e)return;document.getElementById("settingsClassroomId").value=t,document.getElementById("settingsClassroomName").value=e.name,document.getElementById("settingsClassroomDescription").value=e.description||"",e.tab_settings&&(e.tab_settings.names&&(document.getElementById("tabNameGeneral").value=e.tab_settings.names.general||"Genel",document.getElementById("tabNameContent").value=e.tab_settings.names.content||"ƒ∞√ßerik",document.getElementById("tabNameHardware").value=e.tab_settings.names.hardware||"Donanƒ±m",document.getElementById("tabNameCircuit").value=e.tab_settings.names.circuit||"Devre",document.getElementById("tabNameCode").value=e.tab_settings.names.code||"Kod",document.getElementById("tabNameTest").value=e.tab_settings.names.test||"Test"),e.tab_settings.visibility&&(document.getElementById("tabVisGeneral").checked=e.tab_settings.visibility.general!==!1,document.getElementById("tabVisContent").checked=e.tab_settings.visibility.content!==!1,document.getElementById("tabVisHardware").checked=e.tab_settings.visibility.hardware!==!1,document.getElementById("tabVisCircuit").checked=e.tab_settings.visibility.circuit!==!1,document.getElementById("tabVisCode").checked=e.tab_settings.visibility.code!==!1,document.getElementById("tabVisTest").checked=e.tab_settings.visibility.test!==!1));const n=document.getElementById("classroomSettingsModal");n.classList.remove("hidden"),n.classList.add("open")}async function oe(t){t.preventDefault();const e=document.getElementById("settingsClassroomId").value,n=document.getElementById("settingsClassroomName").value,a=document.getElementById("settingsClassroomDescription").value,o={names:{general:document.getElementById("tabNameGeneral").value,content:document.getElementById("tabNameContent").value,hardware:document.getElementById("tabNameHardware").value,circuit:document.getElementById("tabNameCircuit").value,code:document.getElementById("tabNameCode").value,test:document.getElementById("tabNameTest").value},visibility:{general:document.getElementById("tabVisGeneral").checked,content:document.getElementById("tabVisContent").checked,hardware:document.getElementById("tabVisHardware").checked,circuit:document.getElementById("tabVisCircuit").checked,code:document.getElementById("tabVisCode").checked,test:document.getElementById("tabVisTest").checked}};typeof ClassroomManager<"u"&&((await ClassroomManager.update(e,{name:n,description:a,tab_settings:o})).success?(f("classroomSettingsModal"),s("Sƒ±nƒ±f ayarlarƒ± kaydedildi","success")):s("Ayarlar kaydedilemedi","error"))}window.TeacherManager={init:ie,showSection:_,hideLoading:C,updateUserInfo:I,toggleSidebar:D,toggleTheme:P,applyTheme:M,showToast:s,escapeHtml:E,loadDashboardData:w,loadClassrooms:H,loadStudents:j,loadProgress:re,loadProjects:N,closeModal:f,createClassroom:le,viewClassroom:R,toggleClassroom:V,deleteClassroom:z,copyCode:q,shareClassroomCode:U,selectAvatar:b,generateRandomPassword:O,openAddStudentModal:G,addStudent:F,deleteStudent:K,printStudentList:Y,openBulkAddModal:W,previewBulkStudents:Q,resetBulkForm:S,copyBulkList:J,saveBulkStudents:X,selectEditAvatar:k,openEditStudentModal:T,saveStudentEdit:Z,openStudentDetailModal:ae,renderStudentDetailStats:ee,renderStudentCourseProgress:ue,openEditStudentFromDetail:ne,openClassroomSettings:se,saveClassroomSettings:oe};window.showSection=_;window.hideLoading=C;window.updateUserInfo=I;window.toggleSidebar=D;window.toggleTheme=P;window.applyTheme=M;window.showToast=s;window.formatRelativeTime=$;window.loadDashboardData=w;window.openAddStudentModal=G;window.openBulkAddModal=W;window.openClassroomSettings=se;window.toggleClassroom=V;window.deleteClassroom=z;window.viewClassroom=R;window.copyCode=q;window.shareClassroomCode=U;window.previewBulkStudents=Q;window.resetBulkForm=S;window.copyBulkList=J;window.saveBulkStudents=X;window.saveClassroomSettings=oe;window.selectAvatar=b;window.generateRandomPassword=O;window.selectEditAvatar=k;window.openEditStudentModal=T;window.saveStudentEdit=Z;window.openStudentDetailModal=ae;window.openEditStudentFromDetail=ne;window.addStudent=F;window.deleteStudent=K;window.printStudentList=Y;
