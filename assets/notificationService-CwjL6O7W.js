import{S as d}from"./router-Or4wfhGM.js";const r=()=>d.getClient(),f={_subscription:null,_listeners:new Set,_unreadCount:0,async getNotifications({limit:e=20,offset:t=0,unreadOnly:n=!1}={}){const{data:{user:i}}=await r().auth.getUser();if(!i)return[];const{recipientField:s,recipientId:a}=await this._getRecipientInfo(i.id);if(!s)return[];let o=r().from("notifications").select("*").eq(s,a).order("created_at",{ascending:!1}).range(t,t+e-1);n&&(o=o.eq("is_read",!1));const{data:u,error:c}=await o;if(c)throw console.error("Bildirimler yÃ¼klenemedi:",c),c;return u||[]},async getUnreadCount(){const{data:{user:e}}=await r().auth.getUser();if(!e)return 0;const{recipientField:t,recipientId:n}=await this._getRecipientInfo(e.id);if(!t)return 0;const{count:i,error:s}=await r().from("notifications").select("*",{count:"exact",head:!0}).eq(t,n).eq("is_read",!1);return s?(console.error("OkunmamÄ±ÅŸ sayÄ±sÄ± alÄ±namadÄ±:",s),0):(this._unreadCount=i||0,this._unreadCount)},async markAsRead(e){const{data:t,error:n}=await r().from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",e).select().single();if(n)throw console.error("Okundu iÅŸaretleme hatasÄ±:",n),n;return await this.getUnreadCount(),this._notifyListeners(),t},async markAllAsRead(){const{data:{user:e}}=await r().auth.getUser();if(!e)return;const{recipientField:t,recipientId:n}=await this._getRecipientInfo(e.id);if(!t)return;const{error:i}=await r().from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq(t,n).eq("is_read",!1);if(i)throw console.error("Toplu okundu iÅŸaretleme hatasÄ±:",i),i;this._unreadCount=0,this._notifyListeners()},async deleteNotification(e){const{error:t}=await r().from("notifications").delete().eq("id",e);if(t)throw console.error("Bildirim silme hatasÄ±:",t),t;await this.getUnreadCount(),this._notifyListeners()},async clearAll(){const{data:{user:e}}=await r().auth.getUser();if(!e)return;const{recipientField:t,recipientId:n}=await this._getRecipientInfo(e.id);if(!t)return;const{error:i}=await r().from("notifications").delete().eq(t,n);if(i)throw console.error("TÃ¼m bildirimleri silme hatasÄ±:",i),i;this._unreadCount=0,this._notifyListeners()},subscribe(e){return this._listeners.add(e),this._subscription||this._startRealtimeSubscription(),()=>{this._listeners.delete(e),this._listeners.size===0&&this._stopRealtimeSubscription()}},async _startRealtimeSubscription(){const{data:{user:e}}=await r().auth.getUser();if(!e)return;const{recipientField:t,recipientId:n}=await this._getRecipientInfo(e.id);t&&(this._subscription=r().channel("notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`${t}=eq.${n}`},i=>{console.log("[NotificationService] Yeni bildirim:",i.new),this._unreadCount++,this._notifyListeners(i.new),this._showBrowserNotification(i.new)}).subscribe(i=>{console.log("[NotificationService] Subscription status:",i)}))},_stopRealtimeSubscription(){this._subscription&&(r().removeChannel(this._subscription),this._subscription=null)},_notifyListeners(e=null){this._listeners.forEach(t=>{try{t({unreadCount:this._unreadCount,newNotification:e})}catch(n){console.error("Listener hatasÄ±:",n)}})},_showBrowserNotification(e){"Notification"in window&&Notification.permission==="granted"&&new Notification(e.title,{body:e.message||"",icon:"/img/logo.svg",tag:e.id})},async requestPermission(){return"Notification"in window?Notification.permission==="default"?await Notification.requestPermission():Notification.permission:"denied"},async _getRecipientInfo(e){const{data:t}=await r().from("user_profiles").select("id").eq("id",e).single();if(t)return{recipientField:"recipient_user_id",recipientId:t.id};const{data:n}=await r().from("students").select("id").eq("user_id",e).single();return n?{recipientField:"recipient_student_id",recipientId:n.id}:{recipientField:null,recipientId:null}},getIcon(e){return{assignment_created:"ğŸ“‹",assignment_due_soon:"â°",assignment_due_today:"ğŸ””",assignment_overdue:"âš ï¸",submission_received:"ğŸ“¥",submission_graded:"âœ…",submission_returned:"â†©ï¸",course_enrolled:"ğŸ“š",achievement_earned:"ğŸ†",announcement:"ğŸ“¢",system:"âš™ï¸"}[e]||"ğŸ””"},getColor(e){return{assignment_created:"text-blue-500",assignment_due_soon:"text-orange-500",assignment_due_today:"text-red-500",assignment_overdue:"text-red-600",submission_received:"text-green-500",submission_graded:"text-emerald-500",submission_returned:"text-yellow-500",course_enrolled:"text-purple-500",achievement_earned:"text-amber-500",announcement:"text-indigo-500",system:"text-gray-500"}[e]||"text-gray-500"},formatTime(e){const t=new Date(e),i=new Date-t,s=Math.floor(i/6e4),a=Math.floor(i/36e5),o=Math.floor(i/864e5);return s<1?"Az Ã¶nce":s<60?`${s} dk Ã¶nce`:a<24?`${a} saat Ã¶nce`:o<7?`${o} gÃ¼n Ã¶nce`:t.toLocaleDateString("tr-TR")},getCachedUnreadCount(){return this._unreadCount},init(){r().auth.onAuthStateChange((e,t)=>{e==="SIGNED_IN"?(this._startRealtimeSubscription(),this.getUnreadCount()):e==="SIGNED_OUT"&&(this._stopRealtimeSubscription(),this._unreadCount=0)}),this.getUnreadCount()}};export{f as default};
