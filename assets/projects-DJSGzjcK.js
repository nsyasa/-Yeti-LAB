const L={config:{onUpdate:null,onProjectSelect:null,getProjects:()=>[],getPhases:()=>[],getComponentInfo:()=>({}),getCourseKey:()=>"arduino",getCourseId:()=>null,getPhaseIdMap:()=>({})},saveTimer:null,currentProjectId:null,init(n){this.config={...this.config,...n},this.bindEvents()},bindEvents(){let n=null;document.addEventListener("input",t=>{const e=document.getElementById("project-form");if(e&&e.contains(t.target)){const o=t.target.tagName.toLowerCase();(o==="input"||o==="textarea"||o==="select")&&(n&&clearTimeout(n),n=setTimeout(()=>{this.update()},300))}}),document.addEventListener("change",t=>{const e=document.getElementById("project-form");e&&e.contains(t.target)&&(t.target.type==="checkbox"||t.target.tagName.toLowerCase()==="select")&&this.update()})},renderList(n){const t=document.getElementById("project-list");if(!t)return;t.innerHTML="";const e=this.config.getProjects()||[];this.currentProjectId=n;try{if(e.length===0){t.innerHTML='<div class="p-4 text-center text-gray-400 text-sm">Ders bulunamadÄ±.</div>';return}const o=[...e].sort((s,i)=>s.id-i.id);o.forEach((s,i)=>{const r=s.id===n?"bg-blue-50 border-blue-500":"hover:bg-gray-50 border-transparent",l=s.icon||"ðŸ“„",u=typeof s.title=="object"?s.title.tr||s.title.en||"Untitled":s.title||"Untitled",f=i===0,g=i===o.length-1,h=document.createElement("div");h.className=`p-3 border-l-4 cursor-pointer transition ${r} group`,h.innerHTML=`
                    <div class="flex justify-between items-center">
                        <span class="project-title font-bold text-sm text-gray-700 flex-1">#${s.id} ${u}</span>
                        <div class="flex items-center gap-1">
                            <span class="project-icon text-xs text-gray-400 mr-2">${l}</span>
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                                <button onclick="event.stopPropagation(); ProjectManager.moveUp(${s.id})" 
                                    class="w-6 h-6 rounded bg-gray-200 hover:bg-gray-300 text-xs ${f?"invisible":""}" 
                                    title="YukarÄ± TaÅŸÄ±">â†‘</button>
                                <button onclick="event.stopPropagation(); ProjectManager.moveDown(${s.id})" 
                                    class="w-6 h-6 rounded bg-gray-200 hover:bg-gray-300 text-xs ${g?"invisible":""}" 
                                    title="AÅŸaÄŸÄ± TaÅŸÄ±">â†“</button>
                            </div>
                        </div>
                    </div>`,h.onclick=()=>{this.config.onProjectSelect?this.config.onProjectSelect(s.id):this.load(s.id)},h.setAttribute("data-project-id",s.id),t.appendChild(h)})}catch(o){console.error("Error rendering project list:",o),t.innerHTML+='<div class="p-2 text-red-500 text-xs">Hata: Dersler listelenemedi.</div>'}},load(n){this.currentProjectId=n;const e=this.config.getProjects().find(a=>a.id===n);if(!e)return;document.getElementById("project-welcome").classList.add("hidden"),document.getElementById("project-form").classList.remove("hidden");const o=(a,d)=>{const m=document.getElementById(a);m&&(m.value=d??"")};o("p-youtubeUrl",""),o("p-code-image-input",""),o("p-simType-custom",""),o("p-id",e.id);const s=(a,d)=>{const m=document.getElementById(`p-${a}-tr`),x=document.getElementById(`p-${a}-en`);typeof d=="object"&&d!==null?(m&&(m.value=d.tr||""),x&&(x.value=d.en||"")):(m&&(m.value=d||""),x&&(x.value=""))};s("title",e.title),s("desc",e.desc),s("mission",e.mission),s("theory",e.theory),s("challenge",e.challenge),o("p-icon",e.icon),this.populatePhaseDropdown(e.phase),o("p-week",e.week),o("p-difficulty",e.difficulty||"beginner"),o("p-duration",e.duration||""),o("p-tags",e.tags?e.tags.join(", "):""),o("p-prerequisites",e.prerequisites?e.prerequisites.join(", "):"");const i=["mission","materials","circuit","code","challenge","quiz"],r=e.hiddenTabs||[];i.forEach(a=>{const d=document.getElementById(`p-show-${a}`);d&&(d.checked=!r.includes(a),this.toggleSection(a,!0))});const l=document.getElementById("p-simType"),u=document.getElementById("p-simType-custom");let f=!1;for(let a=0;a<l.options.length;a++)if(l.options[a].value===e.simType){l.value=e.simType,f=!0;break}!f&&e.simType?(l.value="custom",u.value=e.simType,u.classList.remove("hidden")):(u.classList.add("hidden"),u.value="");const g=e.code||"",h=g.match(/\.(jpeg|jpg|gif|png)$/)!==null,E=document.getElementById("p-code-mode");E&&(E.value=h?"image":"text",this.toggleCodeMode()),h?(o("p-code",g),o("p-code-image-input",g)):(o("p-code",g),o("p-code-image-input","")),o("p-hasGraph",e.hasGraph?"true":"false"),o("p-challenge",e.challenge),o("p-circuitImage",e.circuitImage||`devre${e.id}.jpg`);const w=document.getElementById("p-circuitEnabled"),b=document.getElementById("circuit-section-content"),j=e.circuitImage&&e.circuitImage!=="";w&&(w.checked=j),b&&(j?b.classList.remove("hidden"):b.classList.add("hidden")),o("p-hotspots",e.hotspots?JSON.stringify(e.hotspots):""),o("p-youtubeUrl",e.youtubeUrl||e.youtube_url||"");const P=document.getElementById("youtube-preview"),c=document.getElementById("p-youtubeUrl");e.youtubeUrl||e.youtube_url?c&&setTimeout(()=>this.validateYouTubeUrl(c),100):(P&&P.classList.add("hidden"),c&&(c.value="",c.classList.remove("border-green-500","border-red-500")));const p=document.getElementById("p-enableHotspots"),v=document.getElementById("p-showInLab"),y=document.getElementById("hotspot-editor-content"),I=e.hotspots&&e.hotspots.length>0||e.enableHotspots;p&&(p.checked=I),v&&(v.checked=e.showHotspotsInLab||!1),I&&y?(y.classList.remove("hidden"),typeof HotspotEditor<"u"&&setTimeout(()=>HotspotEditor.init(),100)):y&&y.classList.add("hidden"),this.renderMaterialsList(e),typeof QuizEditor<"u"&&(e.quiz||(e.quiz=[]),QuizEditor.init(e.id,e.quiz,a=>{e.quiz=a,this.config.onUpdate&&this.config.onUpdate()})),setTimeout(()=>{if(typeof ProjectsSection<"u"&&ProjectsSection.initializeRichTextEditors&&(ProjectsSection.destroyRichTextEditors(),ProjectsSection.initializeRichTextEditors(),window.projectEditors)){const a=(d,m)=>{typeof m=="object"&&m!==null?(d.tr?.setContent&&d.tr.setContent(m.tr||""),d.en?.setContent&&d.en.setContent(m.en||"")):(d.tr?.setContent&&d.tr.setContent(m||""),d.en?.setContent&&d.en.setContent(""))};a(window.projectEditors.mission,e.mission),a(window.projectEditors.theory,e.theory),a(window.projectEditors.challenge,e.challenge),a(window.projectEditors.codeExplanation,e.codeExplanation)}},100),this.renderList(this.currentProjectId)},update(){if(this.currentProjectId===null)return;const t=this.config.getProjects().find(c=>c.id===this.currentProjectId);if(!t)return;const e=document.getElementById("p-phase");t.phase=e?parseInt(e.value)||0:t.phase||0;const o=c=>{if(window.projectEditors&&window.projectEditors[c]){const a=window.projectEditors[c].tr?.getContent()||"",d=window.projectEditors[c].en?.getContent()||"";return d&&d.trim()?{tr:a,en:d}:a}const p=document.getElementById(`p-${c}-tr`),v=document.getElementById(`p-${c}-en`),y=p?p.value:"",I=v?v.value:"";return I&&I.trim()?{tr:y,en:I}:y};t.title=o("title"),t.desc=o("desc"),t.mission=o("mission"),t.theory=o("theory"),t.challenge=o("challenge"),t.codeExplanation=o("codeExplanation"),t.icon=document.getElementById("p-icon").value,t.difficulty=document.getElementById("p-difficulty")?.value||"beginner",t.duration=document.getElementById("p-duration")?.value||"";const s=document.getElementById("p-tags")?.value||"";t.tags=s?s.split(",").map(c=>c.trim()).filter(c=>c):[];const i=document.getElementById("p-prerequisites")?.value||"";t.prerequisites=i?i.split(",").map(c=>parseInt(c.trim())).filter(c=>!isNaN(c)):[];const r=document.getElementById("p-simType");r&&(r.value==="custom"?t.simType=document.getElementById("p-simType-custom")?.value||t.simType:t.simType=r.value);const l=document.getElementById("p-hasGraph");l&&(t.hasGraph=l.value==="true");const u=document.getElementById("p-code-mode");if(u)if(u.value==="text")t.code=document.getElementById("p-code")?.value??t.code;else{const p=document.getElementById("p-code-image-input");t.code=p?p.value:t.code}const f=document.getElementById("p-circuitImage");f&&(t.circuitImage=f.value);const g=document.getElementById("p-youtubeUrl");g&&(t.youtubeUrl=g.value.trim()||null);try{const c=document.getElementById("p-hotspots");if(c){const p=c.value;t.hotspots=p?JSON.parse(p):null}}catch{}const h=Array.from(document.querySelectorAll(".material-checkbox:checked")).map(c=>c.value),E=document.getElementById("p-materials-custom"),w=E?E.value.split(",").map(c=>c.trim()).filter(c=>c!==""):[];t.materials=[...h,...w];const b=document.getElementById("p-enableHotspots"),j=document.getElementById("p-showInLab");b&&(t.enableHotspots=b.checked),j&&(t.showHotspotsInLab=j.checked);const P=["mission","materials","circuit","code","challenge","quiz"];t.hiddenTabs=[],P.forEach(c=>{const p=document.getElementById(`p-show-${c}`);p&&!p.checked&&t.hiddenTabs.push(c)}),this.updateListItemText(t),this.config.onUpdate&&this.config.onUpdate()},scheduleSaveToSupabase(n){},async saveProjectToSupabase(n){const t=this.config.getCourseId?.(),e=this.config.getPhaseIdMap?.();if(!t||!e){console.warn("[ProjectManager] Cannot save to Supabase: missing courseId or phaseIdMap");return}typeof SupabaseSync<"u"&&await SupabaseSync.saveProjectToSupabase(t,n,e)},async add(){const n=this.config.getProjects();if(!n)return;let t=n.length>0?Math.max(...n.map(s=>s.id))+1:0;const e=this.config.getCourseId?.();if(e&&typeof SupabaseClient<"u")try{const{data:s}=await SupabaseClient.getClient().from("projects").select("position").eq("course_id",e).order("position",{ascending:!1}).limit(1);if(s&&s.length>0){const i=s[0].position;t=Math.max(t,i+1)}}catch(s){console.warn("[ProjectManager] Could not check Supabase max position:",s)}const o={id:t,phase:0,title:"Yeni Ders",icon:"âœ¨",desc:"AÃ§Ä±klama...",mission:"AmaÃ§...",theory:"",materials:[],mainComponent:"",code:"// Kod...",challenge:"GÃ¶rev...",hasGraph:!1,simType:"none",circuitImage:`devre${t}.jpg`,difficulty:"beginner",duration:"",tags:[],prerequisites:[]};return n.push(o),this.renderList(t),this.config.onProjectSelect?this.config.onProjectSelect(t):this.load(t),setTimeout(()=>document.getElementById("project-list").scrollTop=9999,100),this.config.onUpdate&&this.config.onUpdate(),await this.saveProjectToSupabase(o),o},async duplicate(){if(this.currentProjectId===null)return;const n=this.config.getProjects(),t=n.find(s=>s.id===this.currentProjectId);if(!t)return;const e=Math.max(...n.map(s=>s.id))+1,o=JSON.parse(JSON.stringify(t));o.id=e,typeof o.title=="object"&&o.title!==null?(o.title.tr=(o.title.tr||"")+" (KopyasÄ±)",o.title.en=(o.title.en||"")+" (Copy)"):o.title+=" (KopyasÄ±)",n.push(o),this.renderList(e),this.config.onProjectSelect?this.config.onProjectSelect(e):this.load(e),this.config.onUpdate&&this.config.onUpdate(),await this.saveProjectToSupabase(o),alert("Ders kopyalandÄ±!")},async delete(){if(!confirm("Bu dersi silmek istediÄŸinize emin misiniz?"))return null;const n=this.config.getProjects(),t=n.find(o=>o.id===this.currentProjectId),e=n.findIndex(o=>o.id===this.currentProjectId);if(e>-1){const o=this.config.getCourseId?.();return o&&typeof SupabaseSync<"u"&&(await SupabaseSync.deleteProjectByPosition(o,t.id)||console.warn("[ProjectManager] Failed to delete from Supabase, continuing with local delete")),n.splice(e,1),this.currentProjectId=null,document.getElementById("project-welcome").classList.remove("hidden"),document.getElementById("project-form").classList.add("hidden"),this.renderList(null),this.config.onUpdate&&this.config.onUpdate(),t}return null},async moveUp(n){const e=[...this.config.getProjects()].sort((s,i)=>s.id-i.id),o=e.findIndex(s=>s.id===n);o<=0||await this.swapProjects(e[o],e[o-1])},async moveDown(n){const e=[...this.config.getProjects()].sort((s,i)=>s.id-i.id),o=e.findIndex(s=>s.id===n);o>=e.length-1||await this.swapProjects(e[o],e[o+1])},async swapProjects(n,t){const e=n.id;n.id=t.id,t.id=e,this.renderList(this.currentProjectId),this.config.onUpdate&&this.config.onUpdate();const o=this.config.getCourseId?.(),s=this.config.getPhaseIdMap?.();o&&s&&typeof SupabaseSync<"u"&&await Promise.all([SupabaseSync.saveProjectToSupabase(o,n,s),SupabaseSync.saveProjectToSupabase(o,t,s)])},getProjectById(n){return this.config.getProjects().find(e=>e.id===n)},getCurrentProject(){return this.currentProjectId===null?null:this.getProjectById(this.currentProjectId)},populatePhaseDropdown(n=0){const t=document.getElementById("p-phase");if(!t)return;const e=this.config.getPhases()||[];if(t.innerHTML="",e.length===0){t.innerHTML='<option value="0">Faz bulunamadÄ±</option>';return}e.forEach((o,s)=>{const i=document.createElement("option");i.value=s;const r=o.title||o.name||`Faz ${s+1}`;i.textContent=`${s}: ${r}`,s===n&&(i.selected=!0),t.appendChild(i)})},renderMaterialsList(n){const t=document.getElementById("p-materials-list");if(!t)return;const e=this.config.getComponentInfo()||{},o=Object.keys(e);let s="";o.length>0?(o.forEach(i=>{const r=e[i];if(!r)return;const l=r.name||i,u=r.icon||"ðŸ“¦",f=n.materials&&n.materials.includes(l),g=l.replace(/"/g,"&quot;").replace(/'/g,"&#39;");s+=`
                    <label class="flex items-center gap-2 p-2 border border-gray-200 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer bg-white dark:bg-gray-800 transition-colors">
                        <input type="checkbox" value="${g}" class="material-checkbox w-4 h-4 text-blue-600 dark:text-blue-400 rounded dark:bg-gray-700 dark:border-gray-600" ${f?"checked":""} onchange="ProjectManager.update()">
                        <span class="text-lg">${u}</span>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300 select-none">${l}</span>
                    </label>`}),t.innerHTML=s):t.innerHTML=`<div class="col-span-full p-4 text-center text-gray-400 dark:text-gray-500 text-sm border-2 border-dashed border-gray-300 dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-800">
                <p>HenÃ¼z kayÄ±tlÄ± malzeme yok.</p>
                <div class="mt-2 text-xs">Sol menÃ¼deki <b>Devre ElemanlarÄ±</b> kÄ±smÄ±ndan malzeme ekleyebilirsiniz.</div>
             </div>`;try{const i=Object.values(e).map(u=>u.name),r=n.materials?n.materials.filter(u=>!i.includes(u)):[],l=document.getElementById("p-materials-custom");l&&(l.value=r.join(", "))}catch(i){console.error("Error processing custom materials",i)}},toggleCustomSimType(){const n=document.getElementById("p-simType"),t=document.getElementById("p-simType-custom");n.value==="custom"?(t.classList.remove("hidden"),t.focus()):t.classList.add("hidden"),this.update()},toggleCodeMode(){const n=document.getElementById("p-code-mode");if(!n)return;const t=document.getElementById("code-text-area"),e=document.getElementById("code-image-area");n.value==="text"?(t&&t.classList.remove("hidden"),e&&e.classList.add("hidden")):(t&&t.classList.add("hidden"),e&&e.classList.remove("hidden")),this.update()},toggleHotspotEnabled(){const n=document.getElementById("p-enableHotspots").checked,t=document.getElementById("hotspot-editor-content");n?(t.classList.remove("hidden"),typeof HotspotEditor<"u"&&HotspotEditor.init()):t.classList.add("hidden"),this.update()},toggleCircuitSection(){const n=document.getElementById("p-circuitEnabled").checked,t=document.getElementById("circuit-section-content");t&&(n?t.classList.remove("hidden"):t.classList.add("hidden")),this.update()},toggleSection(n,t=!1){const e=document.getElementById(`p-show-${n}`),o=e?e.checked:!0;if(n==="mission"){const s=document.getElementById("p-mission-tr");if(s){const i=s.closest(".lang-field")?.parentElement;i&&(i.style.display=o?"block":"none")}}else if(n==="challenge"){const s=document.getElementById("p-challenge-tr");if(s){const i=s.closest(".lang-field")?.parentElement;i&&(i.style.display=o?"block":"none")}}else{const i={materials:"pcontent-donanim",circuit:"pcontent-devre",code:"pcontent-kod",quiz:"pcontent-test"}[n],r=document.getElementById(i);r&&(o?r.classList.remove("hidden"):r.classList.add("hidden"))}t||this.update()},updateListItemText(n){const t=typeof n.title=="object"?n.title.tr||n.title.en||"Untitled":n.title||"Untitled",e=document.querySelector(`[data-project-id="${n.id}"]`);if(e){const o=e.querySelector(".project-title"),s=e.querySelector(".project-icon");o&&(o.textContent=`#${n.id} ${t}`),s&&(s.textContent=n.icon||"ðŸ“„")}},validateYouTubeUrl(n){const t=n.value.trim(),e=document.getElementById("youtube-preview"),o=document.getElementById("youtube-preview-iframe");if(!t){e.classList.add("hidden");return}const s=this.extractYouTubeId(t);if(s)o.src=`https://www.youtube.com/embed/${s}`,e.classList.remove("hidden"),n.classList.remove("border-red-500"),n.classList.add("border-green-500");else{e.classList.add("hidden"),n.classList.add("border-red-500"),n.classList.remove("border-green-500");const i=n.parentElement;let r=i.querySelector(".error-message");r||(r=document.createElement("p"),r.className="error-message text-xs text-red-500 mt-1",i.appendChild(r)),r.textContent="âŒ GeÃ§ersiz YouTube URL. Ã–rnek: https://www.youtube.com/watch?v=dQw4w9WgXcQ",setTimeout(()=>{r&&r.parentElement&&r.remove()},3e3)}},extractYouTubeId(n){const t=[/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,/youtube\.com\/watch\?.*v=([a-zA-Z0-9_-]{11})/];for(const e of t){const o=n.match(e);if(o&&o[1])return o[1]}return null}};window.ProjectManager=L;
