const i={avatars:window.Constants?Constants.AVATARS:["ğŸ‘¨â€ğŸ“","ğŸ‘©â€ğŸ“","ğŸ‘¨â€ğŸ«","ğŸ‘©â€ğŸ«","ğŸ‘¦","ğŸ‘§","ğŸ§‘","ğŸ¤–","ğŸ±","ğŸ¶","ğŸš€","â­"],currentUser:null,isStudentCodeAuth:!1,async init(){typeof SupabaseClient<"u"&&SupabaseClient.init(),typeof Auth<"u"&&await Auth.init();const e=Auth.getUserInfo();if(!e.isLoggedIn){Router.redirectTo("auth.html");return}this.currentUser=e.userId,this.isStudentCodeAuth=e.isStudent&&!e.userId.startsWith("user_");const t=Auth.isProfileComplete||e.isStudent&&!e.isAdmin;window.Navbar&&window.Navbar.updateAuthUI&&window.Navbar.updateAuthUI(),t?this.Settings.init(e):this.Wizard.init(e)},renderHeader(e){document.getElementById("headerName").textContent=e.displayName;const t=document.getElementById("headerAvatar"),a=e.avatarUrl;a&&(a.startsWith("http")||a.startsWith("data:"))?(t.innerHTML=`<img src="${a}" alt="Avatar" class="w-full h-full object-cover rounded-full">`,t.classList.add("overflow-hidden")):(t.textContent=a||(e.isStudent?"ğŸ“":"ğŸ‘¤"),t.classList.remove("overflow-hidden"))},goHome(){Router.redirectTo("index.html")},Wizard:{step:1,data:{role:null,name:"",school:"",city:"",district:"",avatar:""},userInfo:null,init(e){this.userInfo=e,document.getElementById("view-wizard").classList.remove("hidden"),e.displayName&&e.displayName!=="Misafir"&&(document.getElementById("wiz-name").value=e.displayName),this.renderAvatars("wiz-avatar-grid",t=>{this.data.avatar=t,document.querySelectorAll("#wiz-avatar-grid .avatar-option").forEach(a=>a.classList.remove("selected")),event.target.classList.add("selected")}),this.loadCities("wiz-city")},selectRole(e){this.data.role=e,document.querySelectorAll(".role-card").forEach(t=>t.classList.remove("selected")),event.currentTarget.classList.add("selected"),document.getElementById("wiz-btn-1").disabled=!1,document.getElementById("wiz-btn-1").classList.replace("bg-gray-200","bg-theme"),document.getElementById("wiz-btn-1").classList.replace("text-gray-400","text-white")},nextStep(){if(this.step===1&&!this.data.role)return;document.getElementById(`wizard-step-${this.step}`).classList.add("hidden"),this.step++,document.getElementById(`wizard-step-${this.step}`).classList.remove("hidden");const e=document.querySelectorAll(".step-dot");e[this.step-1]&&(e[this.step-1].classList.replace("bg-gray-200","bg-theme"),e[this.step-1].classList.add("ring-4","ring-theme/20"))},prevStep(){this.step!==1&&(document.getElementById(`wizard-step-${this.step}`).classList.add("hidden"),this.step--,document.getElementById(`wizard-step-${this.step}`).classList.remove("hidden"))},renderAvatars(e,t){const a=document.getElementById(e);a.innerHTML=i.avatars.map(n=>`<div onclick="event.stopPropagation();" class="avatar-option text-4xl p-4 bg-gray-50 rounded-xl flex items-center justify-center border-2 border-transparent">
                    ${n}
                </div>`).join(""),Array.from(a.children).forEach((n,s)=>{n.onclick=o=>t(i.avatars[s])})},loadCities(e){const t=document.getElementById(e);window.turkeyData&&Object.keys(window.turkeyData).sort((a,n)=>a.localeCompare(n,"tr")).forEach(a=>{t.add(new Option(a,a))})},async complete(){this.data.name=document.getElementById("wiz-name").value,this.data.school=document.getElementById("wiz-school").value,this.data.city=document.getElementById("wiz-city").value,this.data.district=document.getElementById("wiz-district").value,this.data.avatar||(this.data.avatar="ğŸ‘¤");const e=document.getElementById("wiz-complete-btn");e.disabled=!0,e.innerHTML="Kaydediliyor...",await i.Editor.saveToSupabase(this.data,e,"wiz-error",()=>{typeof Toast<"u"&&Toast.show("Profil oluÅŸturuldu! YÃ¶nlendiriliyorsunuz...","success"),setTimeout(()=>Router.redirectTo("index.html"),1e3)})}},Settings:{async init(e){try{document.getElementById("view-settings").classList.remove("hidden"),i.Editor.populateHero(e),i.Editor.populateFields(e),i.Editor.loadCities(),i.Editor.renderAvatars(),i.Editor.updateThemeButtons(),i.Editor.loadStats().catch(t=>console.warn("Stats load error:",t))}catch(t){console.error("Profile Settings init error:",t),typeof Toast<"u"&&Toast.show("Profil yÃ¼klenirken hata oluÅŸtu: "+t.message,"error")}}},Editor:{currentAvatar:null,populateHero(e){document.getElementById("hero-name").textContent=e.displayName,document.getElementById("hero-email").textContent=e.studentInfo?e.studentInfo.classroomName:Auth.currentUser?.email||"";const t=e.isTeacher?"Ã–ÄŸretmen":"Ã–ÄŸrenci";document.getElementById("hero-role-badge").textContent=t;const a=Auth.currentUser?.created_at?new Date(Auth.currentUser.created_at).toLocaleDateString("tr-TR",{month:"long",year:"numeric"}):"Ocak 2026";document.getElementById("hero-joined").textContent="KatÄ±lÄ±m: "+a;const n=document.getElementById("profile-hero-avatar"),s=document.getElementById("hero-avatar-emoji");e.avatarUrl&&(e.avatarUrl.startsWith("http")||e.avatarUrl.startsWith("data:"))?(n.innerHTML=`<img src="${e.avatarUrl}" alt="Avatar" class="w-full h-full object-cover rounded-full">`,n.classList.add("overflow-hidden","bg-transparent")):(s.textContent=e.avatarUrl||(e.isStudent?"ğŸ“":"ğŸ‘¤"),n.classList.remove("overflow-hidden","bg-transparent")),e.isTeacher&&document.getElementById("teacher-panel-link").classList.remove("hidden")},populateFields(e){const t=Auth.profileData||Auth.currentUser?.user_metadata||{};document.getElementById("view-name").textContent=e.displayName||"â€”",document.getElementById("view-school").textContent=t.school_name||"â€”",document.getElementById("view-city").textContent=t.city||"â€”",document.getElementById("view-district").textContent=t.district||"â€”",document.getElementById("edit-name").value=e.displayName||"",document.getElementById("edit-school").value=t.school_name||"";const a=Auth.currentUser?.app_metadata?.provider;let n="ğŸ“§ Email";a==="google"&&(n="âœ… Google"),a==="github"&&(n="âœ… GitHub"),e.isStudent&&!Auth.currentUser&&(n="ğŸ”‘ SÄ±nÄ±f Kodu"),document.getElementById("view-connections").textContent=n},async loadStats(){if(window.Progress){await Progress.init();const e=Progress.getStats(),t=(n,s)=>{const o=document.getElementById(n);o&&(o.textContent=s)};t("stat-lessons",e.totalLessons),t("stat-badges",e.badges),t("stat-streak",e.streak),t("stat-quiz",(isNaN(e.quizAvg)?0:e.quizAvg)+"%"),t("hero-level-badge","Level "+e.level),t("hero-xp",e.xp),t("hero-next-xp",e.nextLevelXP);const a=document.getElementById("hero-xp-bar");a&&(a.style.width=e.levelProgress+"%"),this.renderBadgeGallery(e.earnedBadges),this.renderHeatmap(Progress.dates)}},renderHeatmap(e){const t=document.getElementById("activity-heatmap");if(!t)return;const a={};(e||[]).forEach(o=>{const r=new Date(o).toISOString().split("T")[0];a[r]=(a[r]||0)+1});const n=new Date;let s="";for(let o=29;o>=0;o--){const r=new Date;r.setDate(n.getDate()-o);const d=r.toISOString().split("T")[0],l=r.toLocaleDateString("tr-TR",{day:"numeric",month:"short"}),c=a[d]||0;let u="bg-gray-100 dark:bg-gray-700";c>0&&(u="bg-theme/40"),c>2&&(u="bg-theme"),s+=`
                    <div class="group relative w-8 h-8 sm:w-10 sm:h-10 rounded-lg ${u} transition-all hover:scale-110 cursor-default">
                        <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-32 bg-gray-900 text-white text-xs p-2 rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10 pointer-events-none text-center">
                            <p class="font-bold">${l}</p>
                            <p>${c} ders</p>
                        </div>
                    </div>
                `}t.innerHTML=s},renderBadgeGallery(e){const t=document.getElementById("badge-gallery");if(!t||!window.BadgeSystem)return;const a=window.BadgeSystem.getAll(),n=e.map(s=>typeof s=="string"?s:s.id);t.innerHTML=a.map(s=>{const o=n.includes(s.id);return`
                    <div class="group relative p-4 rounded-xl border-2 ${o?"border-theme bg-theme/5":"border-gray-200 bg-gray-50"} ${o?"opacity-100":"opacity-40 grayscale"} transition-all hover:scale-105 flex flex-col items-center text-center gap-2">
                        <div class="text-4xl mb-1">${o?s.icon:"ğŸ›¡ï¸"}</div>
                        <div class="font-bold text-sm text-gray-800 dark:text-gray-200">${s.title}</div>
                        <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-48 bg-gray-900 text-white text-xs p-2 rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-10 pointer-events-none">
                            <p class="font-bold mb-1">${s.title}</p>
                            <p>${s.description}</p>
                            ${o?'<p class="mt-1 text-green-300 font-bold">KazanÄ±ldÄ±! ğŸ‰</p>':'<p class="mt-1 text-yellow-300 font-bold">NasÄ±l kazanÄ±lÄ±r?</p>'}
                        </div>
                    </div>`}).join("")},toggleEdit(e){document.getElementById(`card-${e}`).classList.toggle("editing")},cancelEdit(e){document.getElementById(`card-${e}`).classList.remove("editing"),e==="security"&&(document.getElementById("new-password").value="",document.getElementById("new-password-confirm").value="")},async savePersonal(){const e=document.querySelector("#card-personal .btn-save");e.innerHTML,e.textContent="Kaydediliyor...",e.disabled=!0;const t={name:document.getElementById("edit-name").value,school:document.getElementById("edit-school").value,city:document.getElementById("edit-city").value,district:document.getElementById("edit-district").value,avatar:this.currentAvatar||document.getElementById("hero-avatar-emoji").textContent,role:Auth.userRole};await this.saveToSupabase(t,e,null,()=>{document.getElementById("view-name").textContent=t.name,document.getElementById("hero-name").textContent=t.name,document.getElementById("view-school").textContent=t.school,document.getElementById("view-city").textContent=t.city,document.getElementById("view-district").textContent=t.district,this.cancelEdit("personal"),typeof Toast<"u"&&Toast.show("Bilgiler gÃ¼ncellendi","success")})},async savePassword(){const e=document.getElementById("new-password").value,t=document.getElementById("new-password-confirm").value;if(!Validators.minLength(e,6)){Toast?.show("Åifre en az 6 karakter olmalÄ±","error");return}if(!Validators.passwordsMatch(e,t)){Toast?.show("Åifreler eÅŸleÅŸmiyor","error");return}const a=Auth.getUserInfo();if(a.isStudent&&!a.userId.startsWith("user_")){try{const{error:n}=await SupabaseClient.getClient().from("students").update({password:e}).eq("id",a.userId);if(n)throw n;Toast?.show("Åifre gÃ¼ncellendi","success"),this.cancelEdit("security")}catch(n){Toast?.show("Hata: "+n.message,"error")}return}try{const{error:n}=await SupabaseClient.getClient().auth.updateUser({password:e});if(n)throw n;Toast?.show("Åifre gÃ¼ncellendi","success"),this.cancelEdit("security")}catch(n){Toast?.show("Hata: "+n.message,"error")}},toggleAvatarSelector(){document.getElementById("avatar-selector-popup").classList.toggle("hidden")},renderAvatars(){const e=document.getElementById("avatar-grid");e.innerHTML=i.avatars.map(t=>`<div class="avatar-option text-2xl p-2 bg-gray-50 rounded-lg flex items-center justify-center border-2 border-transparent cursor-pointer hover:border-theme" onclick="Profile.Editor.selectAvatar('${t}')">${t}</div>`).join("")},selectAvatar(e){this.currentAvatar=e,document.getElementById("hero-avatar-emoji").textContent=e,this.toggleAvatarSelector()},async saveToSupabase(e,t,a,n,s="Kaydet"){try{const o=Auth.getUserInfo();if(o.isStudent&&!o.userId.startsWith("user_")){const{error:r}=await SupabaseClient.getClient().from("students").update({display_name:e.name}).eq("id",o.userId);if(r)throw r;const d=JSON.parse(localStorage.getItem("yeti_student_session")||"{}");d.displayName=e.name,localStorage.setItem("yeti_student_session",JSON.stringify(d))}else{const r={full_name:e.name,school_name:e.school,city:e.city,district:e.district,avatar_url:e.avatar,role:e.role,profile_completed:!0},{error:d}=await SupabaseClient.getClient().auth.updateUser({data:r});if(d)throw d;try{const l={id:o.userId,full_name:e.name,role:e.role,avatar_url:e.avatar,updated_at:new Date().toISOString()};await SupabaseClient.getClient().from("user_profiles").upsert(l)}catch(l){console.warn("Profile table update skipped:",l)}await Auth.checkSession()}t.textContent="âœ… Kaydedildi",n&&n()}catch(o){console.error(o),typeof Toast<"u"&&Toast.show("Hata: "+o.message,"error"),a&&(document.getElementById(a).textContent=o.message,document.getElementById(a).classList.remove("hidden"))}finally{setTimeout(()=>{t.disabled=!1,t.textContent=s},2e3)}},loadCities(){const e=document.getElementById("edit-city");!e||!window.turkeyData||(e.innerHTML='<option value="">SeÃ§iniz</option>',Object.keys(window.turkeyData).sort((t,a)=>t.localeCompare(a,"tr")).forEach(t=>e.add(new Option(t,t))))},loadDistricts(){const e=document.getElementById("edit-city").value,t=document.getElementById("edit-district");t.innerHTML='<option value="">SeÃ§iniz</option>',e&&window.turkeyData[e]&&window.turkeyData[e].forEach(a=>t.add(new Option(a,a)))},setTheme(e){window.ThemeManager&&ThemeManager.setTheme(e),this.updateThemeButtons(e)},updateThemeButtons(e){const a=(e||(window.ThemeManager?ThemeManager.getCurrentTheme():"dark"))==="light",n=document.getElementById("theme-light-btn"),s=document.getElementById("theme-dark-btn");n&&(n.classList.toggle("bg-theme",a),n.classList.toggle("text-white",a),n.classList.toggle("bg-gray-100",!a)),s&&(s.classList.toggle("bg-theme",!a),s.classList.toggle("text-white",!a),s.classList.toggle("bg-gray-100",a))}},logout(){Auth.signOut().then(()=>{Auth.isStudent()&&Auth.studentLogout(),Router.redirectTo("auth.html")})}};window.Profile=i;window.ProfileEditor=i.Editor;window.Wizard=i.Wizard;window.loadDistricts=(e,t)=>{if(typeof e=="string"&&typeof t=="string"){const a=document.getElementById(e),n=document.getElementById(t);if(a&&n&&window.turkeyData){const s=a.value,o=window.turkeyData[s]||[];n.innerHTML='<option value="">Ä°lÃ§e SeÃ§iniz</option>',o.forEach(r=>n.add(new Option(r,r)))}}else i.Editor.loadDistricts()};
