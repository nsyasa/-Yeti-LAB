const m={config:{onStatusUpdate:null,downloadFallback:null},_isSaving:!1,_pendingSave:null,init(s){this.config={...this.config,...s}},updateStatus(s,e){if(this.config.onStatusUpdate){this.config.onStatusUpdate(s,e);return}const a=document.getElementById("autosave-status");if(!a)return;const t={green:{dot:"bg-green-400",bg:"bg-green-500/20"},red:{dot:"bg-red-400",bg:"bg-red-500/20"},blue:{dot:"bg-blue-400",bg:"bg-blue-500/20"},yellow:{dot:"bg-yellow-400",bg:"bg-yellow-500/20"}},n=t[e]||t.green;a.innerHTML=`
            <span class="inline-block w-2 h-2 rounded-full ${n.dot} ${e==="yellow"||e==="blue"?"animate-pulse":""}"></span>
            <span>${s}</span>
        `,a.className=`flex items-center gap-2 px-4 py-1.5 rounded-full font-bold text-sm ${n.bg}`},slugify(s){if(!s)return"";const e={Ã§:"c",Ã‡:"c",ÄŸ:"g",Äž:"g",ÅŸ:"s",Åž:"s",Ã¼:"u",Ãœ:"u",Ä±:"i",Ä°:"i",Ã¶:"o",Ã–:"o"};return s.toString().replace(/[Ã§Ã‡ÄŸÄžÅŸÅžÃ¼ÃœÄ±Ä°Ã¶Ã–]/g,a=>e[a]||a).normalize("NFKD").replace(/[\u0300-\u036F]/g,"").toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")},async loadCourseList(){try{return await SupabaseClient.getCourses(!1)||[]}catch(s){return console.error("[SupabaseSync] Failed to load course list:",s),[]}},async loadFromSupabase(s){try{this.updateStatus(`ðŸ“¥ ${s} yÃ¼kleniyor...`,"blue");const e=await SupabaseClient.getCourseBySlug(s);if(!e)return console.warn(`[SupabaseSync] Course not found: ${s}`),null;const a=await SupabaseClient.getFullCourseData(e.id),t=SupabaseClient.convertToLegacyFormat(a);return t._supabaseId=e.id,t._position=e.position!==void 0?e.position:999,t._phaseIds={},a.phases.forEach((n,i)=>{t._phaseIds[i]=n.id}),t._projectIds={},a.projects.forEach(n=>{t._projectIds[n.position]=n.id}),this.updateStatus(`âœ… ${s} yÃ¼klendi`,"green"),t}catch(e){return console.error(`[SupabaseSync] Failed to load ${s}:`,e),this.updateStatus(`âŒ ${s} yÃ¼klenemedi`,"red"),null}},async saveProjectToSupabase(s,e,a){try{const n=`p-${e.id!==void 0?e.id:0}`;let i=a[e.phase]||Object.values(a)[0];if(!i){console.warn("[SupabaseSync] No phase ID in map, fetching from database...");try{const{data:c,error:u}=await SupabaseClient.getClient().from("phases").select("id").eq("course_id",s).order("position",{ascending:!0}).limit(1);if(u)throw u;c&&c.length>0&&(i=c[0].id,console.log("[SupabaseSync] Using first phase from database:",i))}catch(c){console.error("[SupabaseSync] Failed to fetch phases:",c)}}if(!i)throw new Error("No valid phase found for project. Please ensure the course has at least one phase defined.");const l={course_id:s,phase_id:i,slug:n,title:typeof e.title=="object"?e.title.tr:e.title,description:typeof e.desc=="object"?e.desc.tr:e.desc,materials:e.materials||[],circuit:e.circuitImage||null,code:e.code||null,simulation:e.simType||null,youtube_url:e.youtubeUrl||null,challenge:typeof e.challenge=="object"?e.challenge.tr:e.challenge,component_info:{id:e.id,icon:e.icon,phase:e.phase,week:e.week,mainComponent:e.mainComponent,hotspots:e.hotspots,hasGraph:e.hasGraph,hasSim:e.hasSim,mission:e.mission,theory:e.theory,quiz:e.quiz,hiddenTabs:e.hiddenTabs,enableHotspots:e.enableHotspots,showHotspotsInLab:e.showHotspotsInLab,difficulty:e.difficulty,duration:e.duration,tags:e.tags,prerequisites:e.prerequisites,title_en:typeof e.title=="object"?e.title.en:null,desc_en:typeof e.desc=="object"?e.desc.en:null,mission_en:typeof e.mission=="object"?e.mission.en:null,theory_en:typeof e.theory=="object"?e.theory.en:null,challenge_en:typeof e.challenge=="object"?e.challenge.en:null},is_published:!1,position:e.id||0};console.log(`[SupabaseSync] Saving project ${n}:`,l.title);const{data:o,error:r}=await SupabaseClient.getClient().from("projects").upsert(l,{onConflict:"course_id,slug"}).select();if(console.log(`[SupabaseSync] Project ${n} response:`,o?.[0]?.id||"no data",r||"success"),r)throw r;return o?.[0]||null}catch(t){return console.error("[SupabaseSync] Failed to save project:",t),null}},async deleteProjectFromSupabase(s){try{return await SupabaseClient.deleteProject(s),!0}catch(e){return console.error("[SupabaseSync] Failed to delete project:",e),!1}},async deleteProjectByPosition(s,e){try{const a=`p-${e}`,{error:t}=await SupabaseClient.getClient().from("projects").delete().eq("course_id",s).eq("slug",a);if(t)throw t;return!0}catch(a){return console.error("[SupabaseSync] Failed to delete project by position:",a),!1}},async savePhaseToSupabase(s,e,a){try{const t=e.title||`BÃ¶lÃ¼m ${a}`,{data:n}=await SupabaseClient.getClient().from("phases").select("id").eq("course_id",s).eq("name",t).maybeSingle();let i;return n?i=await SupabaseClient.updatePhase(n.id,{description:e.description,position:a,meta:{color:e.color,icon:e.icon}}):i=await SupabaseClient.createPhase({course_id:s,name:t,description:e.description||null,position:a,meta:{color:e.color,icon:e.icon}}),i}catch(t){return console.error("[SupabaseSync] Failed to save phase:",t),null}},async deletePhaseFromSupabase(s){try{return await SupabaseClient.deletePhase(s),!0}catch(e){return console.error("[SupabaseSync] Failed to delete phase:",e),!1}},async saveCourseSettings(s,e){try{return await SupabaseClient.updateCourse(s,{title:e.title,description:e.description,meta:{icon:e.icon,customTabNames:e.customTabNames||null}}),!0}catch(a){return console.error("[SupabaseSync] Failed to save course settings:",a),!1}},async saveToSupabase(s,e){console.log("[SupabaseSync] saveToSupabase called:",s);const a=15e3,t=Date.now();if(this._isSaving&&this._lockTimestamp&&t-this._lockTimestamp>a&&(console.warn("[SupabaseSync] Lock stuck for >15s. Forcing reset."),this._isSaving=!1),this._isSaving)return console.log("[SupabaseSync] Save already in progress, queuing..."),this._pendingSave={courseKey:s,courseData:e},this.updateStatus("â³ SÄ±rada bekliyor...","yellow"),!1;this._isSaving=!0,this._lockTimestamp=Date.now();const n=18e4,i=new Promise((o,r)=>setTimeout(()=>r(new Error("TIMEOUT: Ä°stek zaman aÅŸÄ±mÄ±na uÄŸradÄ± (3 dk). BaÄŸlantÄ±nÄ±z yavaÅŸ olabilir.")),n)),l=async()=>{const o=s||this.slugify(e.title);console.log("[SupabaseSync] Step 1: Getting course by slug:",o);let r=await SupabaseClient.getCourseBySlug(o);if(console.log("[SupabaseSync] Step 1 complete: course =",r?.id||"new"),!r){console.log("[SupabaseSync] Creating new course...");const{data:b,error:S}=await SupabaseClient.getClient().from("courses").insert({slug:o,title:e.title,description:e.description||null,meta:{icon:e.icon||null},is_published:!1}).select("id").single();if(S)throw S;r={id:b.id},console.log("[SupabaseSync] New course created:",r.id)}const c=r.id;console.log("[SupabaseSync] Step 2: Updating course metadata..."),console.log("[SupabaseSync] Step 2 Payload:",{title:e.title,description:e.description,metaIcon:e.icon});const{data:u,error:d}=await SupabaseClient.getClient().from("courses").update({title:e.title,description:e.description,meta:{icon:e.icon,customTabNames:e.customTabNames||null}}).eq("id",c).select();if(d)throw d;if(!u||u.length===0)throw console.error("ðŸš¨ CRITICAL: Update returned no data. Possible ID mismatch or RLS issue."),console.error("Attempted to update ID:",c),new Error("Update failed: Course not found or permission denied (RLS). Server returned 0 updated rows.");console.log("âœ… Supabase Confirmed Update:",u),console.log("[SupabaseSync] Step 2 complete"),console.log("[SupabaseSync] Step 3: Syncing phases...");const h=e.data?.phases||[],p=await this.syncPhases(c,h);console.log("[SupabaseSync] Step 3 complete: phaseIdMap =",p),console.log("[SupabaseSync] Step 4: Syncing projects...");const g=e.data?.projects||[];await this.syncProjects(c,g,p),console.log("[SupabaseSync] Step 4 complete"),console.log("[SupabaseSync] Step 5: Syncing components...");const y=e.data?.componentInfo||{};return await this.syncComponents(c,y),console.log("[SupabaseSync] Step 5 complete"),typeof Cache<"u"&&(Cache.clear(`course_${o}`),console.log(`[SupabaseSync] Cache invalidated for course_${o}`),Cache.clear("courses_true"),Cache.clear("courses_false"),Cache.clear("courses_list"),Cache.clear("courses"),console.log("[SupabaseSync] Global course list cache invalidated.")),console.log("[SupabaseSync] All steps complete!"),this.updateStatus(`â˜ï¸ Supabase'e kaydedildi: ${new Date().toLocaleTimeString()}`,"green"),!0};try{return this.updateStatus("â˜ï¸ Supabase'e kaydediliyor...","yellow"),await Promise.race([l(),i]),!0}catch(o){return console.error("Supabase save error:",o),o.code==="401"||o.status===401||o.message?.includes("JWT")?(alert("âš ï¸ Oturum sÃ¼reniz dolmuÅŸ. LÃ¼tfen Ã§Ä±kÄ±ÅŸ yapÄ±p tekrar giriÅŸ yapÄ±n."),this.updateStatus("âŒ Oturum hatasÄ± - Tekrar giriÅŸ yapÄ±n","red"),!1):(o.message?.includes("TIMEOUT")||o.message?.includes("timeout")||o.name==="AbortError")&&(this.updateStatus("â±ï¸ BaÄŸlantÄ± yavaÅŸ - Tekrar deneyin","yellow"),confirm(`BaÄŸlantÄ± yavaÅŸ olduÄŸu iÃ§in iÅŸlem uzun sÃ¼rdÃ¼.

Tekrar denemek ister misiniz?`))?(setTimeout(()=>this.saveToSupabase(s,e),1e3),!1):(this.updateStatus(`âŒ Kaydetme hatasÄ±: ${o.message}`,"red"),confirm(`Supabase'e kaydedilemedi: ${o.message}

Yerel dosya olarak indirmek ister misiniz?`)&&this.config.downloadFallback&&this.config.downloadFallback(s,e),!1)}finally{if(this._isSaving=!1,this._pendingSave){const o=this._pendingSave;this._pendingSave=null,console.log("[SupabaseSync] Processing queued save..."),setTimeout(()=>{this.saveToSupabase(o.courseKey,o.courseData)},100)}}},async syncPhases(s,e){const a={},t=e.map(async(n,i)=>{const l=await this.savePhaseToSupabase(s,n,i);l&&l.id?a[i]=l.id:console.warn(`[SupabaseSync] Failed to sync phase index ${i}`)});return await Promise.all(t),a},async syncProjects(s,e,a){const n=[];console.log(`[SupabaseSync] Syncing ${e.length} projects in chunks of 2...`);for(let l=0;l<e.length;l+=2){const r=e.slice(l,l+2).map(u=>this.saveProjectToSupabase(s,u,a)),c=await Promise.all(r);n.push(...c),this.updateStatus&&console.log(`[SupabaseSync] Saving progress: ${Math.min(l+2,e.length)}/${e.length}`),l+2<e.length&&await new Promise(u=>setTimeout(u,50))}const i=n.filter(l=>l!==null).length;console.log(`[SupabaseSync] Synced ${i}/${e.length} projects`)},async syncComponents(s,e){const a=Object.entries(e).map(([t,n])=>SupabaseClient.upsertComponent({course_id:s,key:t,data:n}));await Promise.all(a)}};window.SupabaseSync=m;
