const b={async getMyAssignments(t={}){const{status:e="active",courseId:i=null,limit:s=50}=t;try{const r=window.SupabaseClient?.client;if(!r)throw new Error("Supabase client not initialized");const{data:{user:n}}=await r.auth.getUser();if(!n)throw new Error("User not authenticated");const{data:a}=await r.from("profiles").select("id, classroom_id").eq("id",n.id).single();if(!a?.classroom_id)return console.warn("[StudentSubmissionService] Student has no classroom"),[];let o=r.from("assignments").select(`
                    *,
                    classroom:classrooms!assignments_classroom_id_fkey(id, name),
                    course:courses!assignments_course_id_fkey(id, title, slug),
                    my_submission:submissions!submissions_assignment_id_fkey(
                        id, status, grade, feedback, submitted_at, graded_at, attempt_number
                    )
                `).eq("classroom_id",a.classroom_id).order("due_date",{ascending:!0,nullsFirst:!1});e==="active"?o=o.in("status",["active"]):o=o.neq("status","archived"),i&&(o=o.eq("course_id",i));const{data:u,error:d}=await o.limit(s);if(d)throw d;return u.map(l=>({...l,my_submission:l.my_submission?.find(c=>!0)||null}))}catch(r){throw console.error("[StudentSubmissionService] getMyAssignments error:",r),r}},async getAssignmentDetail(t){try{const e=window.SupabaseClient?.client;if(!e)throw new Error("Supabase client not initialized");const{data:{user:i}}=await e.auth.getUser();if(!i)throw new Error("User not authenticated");const{data:s,error:r}=await e.from("assignments").select(`
                    *,
                    classroom:classrooms!assignments_classroom_id_fkey(id, name),
                    course:courses!assignments_course_id_fkey(id, title, slug),
                    rubric:rubrics(*)
                `).eq("id",t).single();if(r)throw r;const{data:n,error:a}=await e.from("submissions").select(`
                    *,
                    files:submission_files(*)
                `).eq("assignment_id",t).eq("student_id",i.id).order("submitted_at",{ascending:!1});if(a)throw a;return{...s,my_submissions:n||[],current_submission:n?.[0]||null}}catch(e){throw console.error("[StudentSubmissionService] getAssignmentDetail error:",e),e}},async saveSubmission(t){try{const e=window.SupabaseClient?.client;if(!e)throw new Error("Supabase client not initialized");const{data:{user:i}}=await e.auth.getUser();if(!i)throw new Error("User not authenticated");const{data:s}=await e.from("submissions").select("id, attempt_number").eq("assignment_id",t.assignment_id).eq("student_id",i.id).eq("status","draft").single();if(s){const{data:r,error:n}=await e.from("submissions").update({content:t.content||"",updated_at:new Date().toISOString()}).eq("id",s.id).select().single();if(n)throw n;return r}else{const{data:r}=await e.from("submissions").select("attempt_number").eq("assignment_id",t.assignment_id).eq("student_id",i.id).order("attempt_number",{ascending:!1}).limit(1).single(),n=(r?.attempt_number||0)+1,{data:a,error:o}=await e.from("submissions").insert({assignment_id:t.assignment_id,student_id:i.id,content:t.content||"",status:"draft",attempt_number:n}).select().single();if(o)throw o;return a}}catch(e){throw console.error("[StudentSubmissionService] saveSubmission error:",e),e}},async submitAssignment(t){try{const e=window.SupabaseClient?.client;if(!e)throw new Error("Supabase client not initialized");const{data:i,error:s}=await e.from("submissions").update({status:"submitted",submitted_at:new Date().toISOString()}).eq("id",t).select().single();if(s)throw s;return i}catch(e){throw console.error("[StudentSubmissionService] submitAssignment error:",e),e}},async uploadFile(t,e,i=null){try{const s=window.SupabaseClient?.client;if(!s)throw new Error("Supabase client not initialized");const{data:{user:r}}=await s.auth.getUser();if(!r)throw new Error("User not authenticated");const{data:n}=await s.from("submissions").select("assignment_id").eq("id",t).single();if(!n)throw new Error("Submission not found");const a=e.name.split(".").pop(),o=`${Date.now()}_${Math.random().toString(36).substr(2,9)}.${a}`,u=`${r.id}/${n.assignment_id}/${o}`,{data:d,error:l}=await s.storage.from("submissions").upload(u,e,{cacheControl:"3600",upsert:!1});if(l)throw l;const{data:{publicUrl:c}}=s.storage.from("submissions").getPublicUrl(u),{data:f,error:m}=await s.from("submission_files").insert({submission_id:t,file_name:e.name,file_path:u,file_url:c,file_size:e.size,file_type:e.type||"application/octet-stream"}).select().single();if(m)throw m;return f}catch(s){throw console.error("[StudentSubmissionService] uploadFile error:",s),s}},async deleteFile(t){try{const e=window.SupabaseClient?.client;if(!e)throw new Error("Supabase client not initialized");const{data:i}=await e.from("submission_files").select("file_path").eq("id",t).single();i?.file_path&&await e.storage.from("submissions").remove([i.file_path]);const{error:s}=await e.from("submission_files").delete().eq("id",t);if(s)throw s;return!0}catch(e){throw console.error("[StudentSubmissionService] deleteFile error:",e),e}},getAssignmentStatus(t){const e=new Date,i=t.due_date?new Date(t.due_date):null,s=t.my_submission||t.current_submission;return t.status==="closed"?{code:"closed",label:"Kapalƒ±",color:"gray",icon:"üîí",canSubmit:!1}:s?.status==="graded"?{code:"graded",label:"Notlandƒ±rƒ±ldƒ±",color:"green",icon:"‚úÖ",canSubmit:!1}:s?.status==="revision_requested"?{code:"revision",label:"Revizyon ƒ∞stendi",color:"orange",icon:"üîÑ",canSubmit:!0}:s?.status==="submitted"?{code:"submitted",label:"G√∂nderildi",color:"blue",icon:"üì§",canSubmit:!1}:s?.status==="draft"?{code:"draft",label:"Taslak",color:"yellow",icon:"üìù",canSubmit:!0}:i&&e>i?t.allow_late_submission?{code:"late",label:"Ge√ß Teslim",color:"red",icon:"‚è∞",canSubmit:!0}:{code:"overdue",label:"S√ºresi Doldu",color:"red",icon:"‚ùå",canSubmit:!1}:{code:"pending",label:"Bekliyor",color:"gray",icon:"‚è≥",canSubmit:!0}},getTimeRemaining(t){if(!t)return{text:"S√ºresiz",days:null,urgent:!1,overdue:!1};const e=new Date,s=new Date(t)-e;if(s<0){const o=Math.abs(Math.ceil(s/864e5));return{text:`${o} g√ºn ge√ßti`,days:-o,urgent:!1,overdue:!0}}const r=Math.floor(s/(1e3*60*60*24)),n=Math.floor(s%(1e3*60*60*24)/(1e3*60*60)),a=Math.floor(s%(1e3*60*60)/(1e3*60));return r>7?{text:`${r} g√ºn`,days:r,urgent:!1,overdue:!1}:r>0?{text:`${r} g√ºn ${n} saat`,days:r,urgent:r<=2,overdue:!1}:n>0?{text:`${n} saat ${a} dk`,days:0,urgent:!0,overdue:!1}:{text:`${a} dakika`,days:0,urgent:!0,overdue:!1}},formatDate(t){return t?new Date(t).toLocaleDateString("tr-TR",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-"},formatFileSize(t){if(!t)return"0 B";const e=["B","KB","MB","GB"],i=Math.floor(Math.log(t)/Math.log(1024));return(t/Math.pow(1024,i)).toFixed(1)+" "+e[i]},getStatusBadgeHtml(t){return`<span class="px-2 py-1 text-xs font-medium rounded-full ${{green:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400",blue:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",yellow:"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400",orange:"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400",red:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",gray:"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300"}[t.color]}">${t.icon} ${t.label}</span>`}};window.StudentSubmissionService=b;export{b as StudentSubmissionService,b as default};
