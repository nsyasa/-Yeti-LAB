const g={_isSessionTokenStudent(){return!!window.Auth?.currentStudent?.sessionToken},_getSessionToken(){return window.Auth?.currentStudent?.sessionToken},async getMyAssignments(t={}){const{status:e="active",courseId:o=null,limit:s=50}=t;try{const i=window.SupabaseClient?.client||window.SupabaseClient?.getClient();if(!i)throw new Error("Supabase client not initialized");if(this._isSessionTokenStudent()){const u=this._getSessionToken(),{data:_,error:b}=await i.rpc("student_list_assignments",{p_session_token:u});if(b)throw b;let c=(_||[]).map(r=>({id:r.id,title:r.title,description:r.description,status:r.status,due_date:r.due_date,max_score:r.max_score,late_submission_allowed:r.late_submission_allowed,course_id:r.course_id,created_at:r.created_at,course:r.course_id?{id:r.course_id,title:r.course_title,slug:null}:null,my_submission:r.my_submission_id?{id:r.my_submission_id,status:r.my_submission_status,grade:r.my_submission_score}:null}));return e==="active"&&(c=c.filter(r=>r.status==="published")),o&&(c=c.filter(r=>r.course_id===o)),c.slice(0,s)}const{data:{user:a}}=await i.auth.getUser();if(!a)throw new Error("User not authenticated");const{data:l}=await i.from("profiles").select("id, classroom_id").eq("id",a.id).single();if(!l?.classroom_id)return console.warn("[StudentSubmissionService] Student has no classroom"),[];let n=i.from("assignments").select(`
                    *,
                    classroom:classrooms!assignments_classroom_id_fkey(id, name),
                    course:courses!assignments_course_id_fkey(id, title, slug),
                    my_submission:submissions!submissions_assignment_id_fkey(
                        id, status, grade, feedback, submitted_at, graded_at, attempt_number
                    )
                `).eq("classroom_id",l.classroom_id).order("due_date",{ascending:!0,nullsFirst:!1});e==="active"?n=n.in("status",["active"]):n=n.neq("status","archived"),o&&(n=n.eq("course_id",o));const{data:d,error:m}=await n.limit(s);if(m)throw m;return d.map(u=>({...u,my_submission:u.my_submission?.find(_=>!0)||null}))}catch(i){throw console.error("[StudentSubmissionService] getMyAssignments error:",i),i}},async getAssignmentDetail(t){try{const e=window.SupabaseClient?.client||window.SupabaseClient?.getClient();if(!e)throw new Error("Supabase client not initialized");if(this._isSessionTokenStudent()){const n=this._getSessionToken(),{data:d,error:m}=await e.rpc("student_list_assignments",{p_session_token:n});if(m)throw m;const u=(d||[]).find(r=>r.id===t);if(!u)throw new Error("Assignment not found or not accessible");const{data:_,error:b}=await e.rpc("student_list_submissions",{p_session_token:n});if(b)throw b;const c=(_||[]).filter(r=>r.assignment_id===t).sort((r,f)=>new Date(f.created_at)-new Date(r.created_at));return{id:u.id,title:u.title,description:u.description,status:u.status,due_date:u.due_date,max_score:u.max_score,late_submission_allowed:u.late_submission_allowed,course:u.course_id?{id:u.course_id,title:u.course_title,slug:null}:null,classroom:null,rubric:null,my_submissions:c,current_submission:c[0]||null}}const{data:{user:o}}=await e.auth.getUser();if(!o)throw new Error("User not authenticated");const{data:s,error:i}=await e.from("assignments").select(`
                    *,
                    classroom:classrooms!assignments_classroom_id_fkey(id, name),
                    course:courses!assignments_course_id_fkey(id, title, slug),
                    rubric:rubrics(*)
                `).eq("id",t).single();if(i)throw i;const{data:a,error:l}=await e.from("submissions").select(`
                    *,
                    files:submission_files(*)
                `).eq("assignment_id",t).eq("student_id",o.id).order("submitted_at",{ascending:!1});if(l)throw l;return{...s,my_submissions:a||[],current_submission:a?.[0]||null}}catch(e){throw console.error("[StudentSubmissionService] getAssignmentDetail error:",e),e}},async saveSubmission(t){try{const e=window.SupabaseClient?.client||window.SupabaseClient?.getClient();if(!e)throw new Error("Supabase client not initialized");if(this._isSessionTokenStudent()){const i=this._getSessionToken(),{data:a,error:l}=await e.rpc("student_upsert_submission",{p_session_token:i,p_assignment_id:t.assignment_id,p_content:t.content||"",p_status:"draft"});if(l)throw l;const n=Array.isArray(a)?a[0]:a;return{id:n?.id||null,status:n?.status||"draft",attempt_number:n?.attempt_number||1,submitted_at:null,content:t.content||"",files:[]}}const{data:{user:o}}=await e.auth.getUser();if(!o)throw new Error("User not authenticated");const{data:s}=await e.from("submissions").select("id, attempt_number").eq("assignment_id",t.assignment_id).eq("student_id",o.id).eq("status","draft").single();if(s){const{data:i,error:a}=await e.from("submissions").update({content:t.content||"",updated_at:new Date().toISOString()}).eq("id",s.id).select().single();if(a)throw a;return i}else{const{data:i}=await e.from("submissions").select("attempt_number").eq("assignment_id",t.assignment_id).eq("student_id",o.id).order("attempt_number",{ascending:!1}).limit(1).single(),a=(i?.attempt_number||0)+1,{data:l,error:n}=await e.from("submissions").insert({assignment_id:t.assignment_id,student_id:o.id,content:t.content||"",status:"draft",attempt_number:a}).select().single();if(n)throw n;return l}}catch(e){throw console.error("[StudentSubmissionService] saveSubmission error:",e),e}},async submitAssignment(t){try{const e=window.SupabaseClient?.client||window.SupabaseClient?.getClient();if(!e)throw new Error("Supabase client not initialized");if(this._isSessionTokenStudent()){const i=this._getSessionToken(),{data:a,error:l}=await e.rpc("student_list_submissions",{p_session_token:i});if(l)throw l;const n=(a||[]).find(_=>_.id===t);if(!n)throw new Error("Submission not found or not accessible");const{data:d,error:m}=await e.rpc("student_upsert_submission",{p_session_token:i,p_assignment_id:n.assignment_id,p_content:n.content||"",p_status:"submitted"});if(m)throw m;return{id:(Array.isArray(d)?d[0]:d)?.id||t,status:"submitted",submitted_at:new Date().toISOString(),content:n.content||""}}const{data:o,error:s}=await e.from("submissions").update({status:"submitted",submitted_at:new Date().toISOString()}).eq("id",t).select().single();if(s)throw s;return o}catch(e){throw console.error("[StudentSubmissionService] submitAssignment error:",e),e}},async uploadFile(t,e,o=null){try{if(this._isSessionTokenStudent())throw new Error("File uploads are not supported for session-token students yet.");const s=window.SupabaseClient?.client||window.SupabaseClient?.getClient();if(!s)throw new Error("Supabase client not initialized");const{data:{user:i}}=await s.auth.getUser();if(!i)throw new Error("User not authenticated");const{data:a}=await s.from("submissions").select("assignment_id").eq("id",t).single();if(!a)throw new Error("Submission not found");const l=e.name.split(".").pop(),n=`${Date.now()}_${Math.random().toString(36).substr(2,9)}.${l}`,d=`${i.id}/${a.assignment_id}/${n}`,{data:m,error:u}=await s.storage.from("submissions").upload(d,e,{cacheControl:"3600",upsert:!1});if(u)throw u;const{data:{publicUrl:_}}=s.storage.from("submissions").getPublicUrl(d),{data:b,error:c}=await s.from("submission_files").insert({submission_id:t,file_name:e.name,file_path:d,file_url:_,file_size:e.size,file_type:e.type||"application/octet-stream"}).select().single();if(c)throw c;return b}catch(s){throw console.error("[StudentSubmissionService] uploadFile error:",s),s}},async deleteFile(t){try{if(this._isSessionTokenStudent())throw new Error("File operations are not supported for session-token students yet.");const e=window.SupabaseClient?.client||window.SupabaseClient?.getClient();if(!e)throw new Error("Supabase client not initialized");const{data:o}=await e.from("submission_files").select("file_path").eq("id",t).single();o?.file_path&&await e.storage.from("submissions").remove([o.file_path]);const{error:s}=await e.from("submission_files").delete().eq("id",t);if(s)throw s;return!0}catch(e){throw console.error("[StudentSubmissionService] deleteFile error:",e),e}},getAssignmentStatus(t){const e=new Date,o=t.due_date?new Date(t.due_date):null,s=t.my_submission||t.current_submission;return t.status==="closed"?{code:"closed",label:"Kapalƒ±",color:"gray",icon:"üîí",canSubmit:!1}:s?.status==="graded"?{code:"graded",label:"Notlandƒ±rƒ±ldƒ±",color:"green",icon:"‚úÖ",canSubmit:!1}:s?.status==="revision_requested"?{code:"revision",label:"Revizyon ƒ∞stendi",color:"orange",icon:"üîÑ",canSubmit:!0}:s?.status==="submitted"?{code:"submitted",label:"G√∂nderildi",color:"blue",icon:"üì§",canSubmit:!1}:s?.status==="draft"?{code:"draft",label:"Taslak",color:"yellow",icon:"üìù",canSubmit:!0}:o&&e>o?t.allow_late_submission?{code:"late",label:"Ge√ß Teslim",color:"red",icon:"‚è∞",canSubmit:!0}:{code:"overdue",label:"S√ºresi Doldu",color:"red",icon:"‚ùå",canSubmit:!1}:{code:"pending",label:"Bekliyor",color:"gray",icon:"‚è≥",canSubmit:!0}},getTimeRemaining(t){if(!t)return{text:"S√ºresiz",days:null,urgent:!1,overdue:!1};const e=new Date,s=new Date(t)-e;if(s<0){const n=Math.abs(Math.ceil(s/864e5));return{text:`${n} g√ºn ge√ßti`,days:-n,urgent:!1,overdue:!0}}const i=Math.floor(s/(1e3*60*60*24)),a=Math.floor(s%(1e3*60*60*24)/(1e3*60*60)),l=Math.floor(s%(1e3*60*60)/(1e3*60));return i>7?{text:`${i} g√ºn`,days:i,urgent:!1,overdue:!1}:i>0?{text:`${i} g√ºn ${a} saat`,days:i,urgent:i<=2,overdue:!1}:a>0?{text:`${a} saat ${l} dk`,days:0,urgent:!0,overdue:!1}:{text:`${l} dakika`,days:0,urgent:!0,overdue:!1}},formatDate(t){return t?new Date(t).toLocaleDateString("tr-TR",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}):"-"},formatFileSize(t){if(!t)return"0 B";const e=["B","KB","MB","GB"],o=Math.floor(Math.log(t)/Math.log(1024));return(t/Math.pow(1024,o)).toFixed(1)+" "+e[o]},getStatusBadgeHtml(t){return`<span class="px-2 py-1 text-xs font-medium rounded-full ${{green:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400",blue:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",yellow:"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400",orange:"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400",red:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",gray:"bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300"}[t.color]}">${t.icon} ${t.label}</span>`}};window.StudentSubmissionService=g;export{g as StudentSubmissionService,g as default};
